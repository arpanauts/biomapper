# Task: Create `MappingExecutorInitializer`
# Task: Extract `RobustExecutionCoordinator` from `MappingExecutor`
# Task: Create Unit Tests for `CheckpointManager`

## Objective
To simplify the instantiation and setup of `MappingExecutor`, extract the complex initialization logic, including database table creation, into a `MappingExecutorInitializer` (or Factory) class.

## Current Implementation
`MappingExecutor` has a static `create` method that handles asynchronous instantiation and initialization, including calling `_init_db_tables`. The `__init__` method itself is also quite large.

## Refactoring Steps

1.  **Create the `MappingExecutorInitializer` Class:**
    *   Create a new file: `biomapper/core/engine_components/mapping_executor_initializer.py` (or `biomapper/core/factories/mapping_executor_factory.py`).
    *   Define a `MappingExecutorInitializer` class.

2.  **Move Initialization Logic:**
    *   Move the logic from the static `MappingExecutor.create` method into a method in `MappingExecutorInitializer`, e.g., `async create_executor(...)`.
    *   Move the `MappingExecutor._init_db_tables` method into `MappingExecutorInitializer` as a helper method, or integrate its logic directly into `create_executor`.
    *   The `create_executor` method will be responsible for:
        *   Creating database engines (perhaps by instantiating `SessionManager` first, or if `SessionManager` also needs complex setup, this initializer could handle that too).
        *   Ensuring database tables are created for both metamapper and cache DBs.
        *   Instantiating all necessary components that `MappingExecutor` depends on (e.g., `SessionManager`, `ClientManager`, `ConfigLoader`, `IdentifierLoader`, `ProgressReporter`, `CacheManager`, `PathFinder`, `StrategyOrchestrator`, `CheckpointManager`, and the newly proposed services like `MetadataQueryService`, `RobustExecutionCoordinator`, `ExecutionTraceLogger`).
        *   Finally, instantiating `MappingExecutor` itself, passing all its dependencies to a (now potentially simpler) `__init__` method.

3.  **Simplify `MappingExecutor`:**
    *   Remove the static `create` method from `MappingExecutor`.
    *   Remove the `_init_db_tables` method from `MappingExecutor`.
    *   Simplify `MappingExecutor.__init__` to primarily accept already instantiated dependencies. It should no longer create engines or other components itself, but receive them as arguments.

4.  **Update Usage:**
    *   Anywhere `MappingExecutor.create(...)` was called, it should now instantiate `MappingExecutorInitializer` and call its `create_executor(...)` method.
To separate high-level execution lifecycle management (including robustness features like checkpointing and retries) from core strategy orchestration, extract this logic from `MappingExecutor` into a `RobustExecutionCoordinator` class.

## Current Implementation
`MappingExecutor` has methods like `execute_robust_yaml_strategy` which wrap the core strategy execution with additional features like checkpoint loading/saving and potentially retry mechanisms.
To ensure the reliability of the `CheckpointManager` class, create comprehensive unit tests. This task focuses specifically on the `CheckpointManager` component.

## Refactoring Steps

1.  **Create the `RobustExecutionCoordinator` Class:**
    *   Create a new file: `biomapper/core/engine_components/robust_execution_coordinator.py`.
    *   Define a `RobustExecutionCoordinator` class.
    *   Its `__init__` method should accept dependencies such as `StrategyOrchestrator`, `CheckpointManager`, `ProgressReporter`, and potentially `MappingExecutor`'s configuration for retries, batch sizes if these are managed at this level.

2.  **Move Robust Execution Logic:**
    *   Transfer the logic from `MappingExecutor.execute_robust_yaml_strategy` (and any helper methods exclusively used by it for robustness) into a primary method in `RobustExecutionCoordinator`, e.g., `execute_strategy_robustly(...)`.
    *   This includes:
        *   Generating execution IDs.
        *   Loading checkpoints via `CheckpointManager`.
        *   Implementing retry logic (if present or planned here).
        *   Calling the `StrategyOrchestrator` to execute the actual strategy steps.
        *   Handling high-level exceptions from the orchestration and updating checkpoint/progress status.
        *   Saving/clearing checkpoints via `CheckpointManager`.
        *   Reporting overall execution status (start, failure, completion) via `ProgressReporter`.

3.  **Update `MappingExecutor`:**
    *   In `MappingExecutor.__init__`, instantiate `RobustExecutionCoordinator` with its required dependencies.
    *   The public method in `MappingExecutor` (e.g., `execute_robust_yaml_strategy`) should now primarily delegate to the `RobustExecutionCoordinator.execute_strategy_robustly(...)` method.
    *   Remove the transferred logic from `MappingExecutor`.
    *   Update imports as necessary.
## Location for Tests
Add tests to the file: `tests/core/engine_components/test_managers.py`
(Create this file if it doesn't exist, or add to it if `ClientManager` tests are already present).

## `CheckpointManager` Test Cases

Use `pytest`'s `tmp_path` fixture to create temporary directories for testing file operations.

1.  **Test Save Checkpoint**: Verify that `save_checkpoint` correctly creates a JSON file in the specified checkpoint directory with the expected content.
2.  **Test Load Checkpoint**: Save a checkpoint, then use `load_checkpoint` to read it back and assert that the loaded data matches the original data.
3.  **Test Clear Checkpoint**: Verify that `clear_checkpoint` successfully deletes the checkpoint file.
4.  **Test Load Non-existent Checkpoint**: Assert that `load_checkpoint` returns `None` or handles the case gracefully (e.g., by raising a specific, documented error or logging a warning and returning None) when no checkpoint file exists.
5.  **Test Checkpoint Directory Creation**: Ensure the `CheckpointManager` automatically creates the checkpoint directory (e.g., `~/.biomapper/checkpoints/`) if it does not exist when a checkpoint is saved.

## Acceptance Criteria
*   `MappingExecutorInitializer` class is implemented and handles the creation and setup of `MappingExecutor` instances.
*   Database table initialization logic is moved to `MappingExecutorInitializer`.
*   `MappingExecutor.__init__` is simplified, primarily accepting pre-configured dependencies.
*   The static `create` method is removed from `MappingExecutor`.
*   The application can still correctly instantiate and use `MappingExecutor` instances via the new initializer.
*   `RobustExecutionCoordinator` class is implemented and manages the robust execution lifecycle of strategies.
*   Logic related to checkpoint integration and high-level retry/error handling for strategy execution is moved from `MappingExecutor` to this new class.
*   `MappingExecutor` uses `RobustExecutionCoordinator` for executing strategies that require these robustness features.
*   The application's strategy execution, including checkpointing, functions as before.
*   Unit tests for `CheckpointManager` are implemented in `tests/core/engine_components/test_managers.py`.
*   The test suite achieves high code coverage for `biomapper/core/engine_components/checkpoint_manager.py`.
*   All `CheckpointManager` tests pass successfully.
