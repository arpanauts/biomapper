# Task: Decompose Iterative Secondary Mapping from `execute_mapping`

## 1. Task Objective
Extract the complex iterative mapping loop from the `MappingExecutor.execute_mapping` method into a new, specialized service class. This service will manage the state and execution of secondary path finding and mapping for identifiers that were not mapped in the initial direct pass.

## 2. Context and Background
The core of the monolithic `execute_mapping` method is a large `while` loop that iteratively finds and executes secondary mapping paths for unmapped identifiers. This stateful and complex process is a prime candidate for extraction into its own service to significantly simplify the `MappingExecutor`.

## 3. Key Memories and Documents
- **Source File:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/mapping_executor.py`
- **Starter Prompt:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/_starter_prompt.md`

## 4. Success Criteria
- A new service class (e.g., `IterativeMappingService`) is created in a new file under `biomapper/core/services/`.
- This service contains the logic of the iterative mapping loop, including finding alternative paths, executing them, and managing the set of unmapped identifiers.
- The `MappingExecutor.execute_mapping` method is updated to delegate the iterative mapping phase to this new service.
- The `execute_mapping` method should be dramatically shorter and simpler after this refactoring.
- All relevant integration tests must pass, ensuring the behavior of the iterative mapping process is preserved.

## 5. Implementation Requirements
- **Input files/data:** `mapping_executor.py`
- **Expected outputs:** A new service file (e.g., `biomapper/core/services/iterative_mapping_service.py`) and a modified `mapping_executor.py`.
- **Code standards:** The new service should be designed to be stateful if necessary to manage the iterative process. Use async methods and pass dependencies via the constructor.

## 6. Error Recovery Instructions
- The main challenge will be managing the state (e.g., `unmapped_from_source`, `mapped_results`, `tested_paths`) that was previously local to the `execute_mapping` method. Ensure this state is correctly passed to, managed within, and returned from the new service.
- Test failures will likely point to incorrect state management. Debug by comparing the state at each iteration between the old and new implementations.

## 7. Feedback and Reporting
- **File Path:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/feedback/YYYY-MM-DD-HHMMSS-feedback-refactor-executor-iterative-mapping.md`
- **Content:**
    - **Completed Subtasks:** Detail the creation of the `IterativeMappingService` and the removal of the loop from `execute_mapping`.
    - **Issues Encountered:** Describe challenges related to state management during the extraction.
    - **Next Action Recommendation:** State readiness for subsequent `execute_mapping` refactoring tasks.
    - **Confidence Assessment:** Medium. The logic is complex and stateful, requiring careful extraction.
# Task: Refactor `_execute_mapping_step` into a Dedicated Service

## 1. Task Objective
Extract the logic from the `MappingExecutor._execute_mapping_step` method into a new `MappingStepExecutionService`. This will isolate the responsibility of executing a single step of a mapping path, including client interaction, caching, and error handling.
# Task: Decompose Result Aggregation from `execute_mapping`

## 1. Task Objective
Extract the final result aggregation and bundling logic from the end of the `MappingExecutor.execute_mapping` method into a new, dedicated service. This service will be responsible for taking the raw mapping results and packaging them into the final `MappingResultBundle`.

## 2. Context and Background
After the mapping iterations in `execute_mapping` are complete, there is a block of code that collects all the mapped and unmapped identifiers, calculates summary statistics, and constructs the `MappingResultBundle` object. This is a distinct responsibility that can be cleanly separated from the mapping execution logic itself.

## 3. Key Memories and Documents
- **Source File:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/mapping_executor.py`
- **Result Model:** `biomapper/core/models/result_bundle.py`
- **Starter Prompt:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/_starter_prompt.md`

## 4. Success Criteria
- A new service class (e.g., `ResultAggregationService`) is created in a new file under `biomapper/core/services/`.
- This service takes the various collections of mapped and unmapped data as input and is solely responsible for creating the `MappingResultBundle`.
- The `MappingExecutor.execute_mapping` method is simplified by delegating the final result bundling to this new service.
- The `execute_mapping` method's return signature will now directly return the `MappingResultBundle` produced by the new service.
- All tests that inspect the contents of the `MappingResultBundle` must pass.

## 5. Implementation Requirements
- **Input files/data:** `mapping_executor.py`
- **Expected outputs:** A new service file (e.g., `biomapper/core/services/result_aggregation_service.py`) and a modified `mapping_executor.py`.
- **Code standards:** The new service should be stateless, taking all necessary data as arguments to its primary method.

## 2. Context and Background
The `_execute_mapping_step` method in `MappingExecutor` is responsible for the fine-grained details of running one step in a `MappingPath`. This includes loading the correct client, calling its `map` method, handling reverse execution, and interacting with the cache. Separating this into its own service improves cohesion and simplifies the executor.

## 3. Key Memories and Documents
- **Source File:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/mapping_executor.py`
- **Starter Prompt:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/_starter_prompt.md`

## 4. Success Criteria
- A new `MappingStepExecutionService` class is created in a new file under `biomapper/core/services/`.
- The logic from `_execute_mapping_step` is moved into a method within this new service (e.g., `execute_step`).
- The `MappingExecutor`'s internal path execution logic is updated to use this new service, simplifying its own code.
- The new service should be injectable into other services that might need to execute a single step (like the `PathExecutionService`).
- All tests related to executing mapping paths must pass.

## 5. Implementation Requirements
- **Input files/data:** `mapping_executor.py`
- **Expected outputs:** A new service file (e.g., `biomapper/core/services/mapping_step_execution_service.py`) and a modified `mapping_executor.py`.
- **Code standards:** The new service should be injected with dependencies it needs, such as the `ClientManager` and `CacheManager`.

## 6. Error Recovery Instructions
- Ensure that all context required by the step execution logic (e.g., `is_reverse` flag, input values, the `MappingPathStep` object) is passed correctly to the new service.
- Failures in mapping path tests will likely be due to an incomplete or incorrect transfer of logic or state to the new service.

## 7. Feedback and Reporting
- **File Path:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/feedback/YYYY-MM-DD-HHMMSS-feedback-refactor-executor-step-execution.md`
- **Content:**
    - **Completed Subtasks:** Report on the creation of the new service and the refactoring of the executor.
    - **Issues Encountered:** Document any challenges in isolating the step execution logic.
    - **Next Action Recommendation:** Confirm that this refactoring simplifies the main path execution loop.
    - **Confidence Assessment:** High. This is a well-defined piece of logic to extract.
## 6. Error Recovery Instructions
- Ensure the data structures passed to the new service (e.g., dictionaries of mapped results) are in the expected format.
- Mismatches in the final `MappingResultBundle` are likely due to incorrect data being passed to the new service. Verify the inputs at the boundary between the executor and the aggregator.

## 7. Feedback and Reporting
- **File Path:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/feedback/YYYY-MM-DD-HHMMSS-feedback-refactor-executor-result-aggregation.md`
- **Content:**
    - **Completed Subtasks:** Report on the creation of the new service and the simplification of `execute_mapping`.
    - **Issues Encountered:** Note any difficulties in separating the aggregation logic.
    - **Next Action Recommendation:** Confirm that the `execute_mapping` method is now fully decomposed.
    - **Confidence Assessment:** High. This is a straightforward extraction of data transformation logic.
# Task: Decompose Bidirectional Validation from `execute_mapping`

## 1. Task Objective
Extract the logic for bidirectional validation from the `MappingExecutor.execute_mapping` method into a new, self-contained service. This service will handle the process of re-running mappings in the reverse direction to validate the initial results.

## 2. Context and Background
Within the large `execute_mapping` method, there is a conditional block that, if `bidirectional_validation` is enabled, triggers a recursive or secondary mapping process in the reverse direction. This is a distinct and complex feature that should reside in its own specialized service.

## 3. Key Memories and Documents
- **Source File:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/mapping_executor.py`
- **Starter Prompt:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/_starter_prompt.md`

## 4. Success Criteria
- A new service class (e.g., `BidirectionalValidationService`) is created in a new file under `biomapper/core/services/`.
- The service encapsulates the logic for performing the reverse mapping and comparing the results against the forward mapping.
- The `MappingExecutor.execute_mapping` method is simplified by replacing the inline validation logic with a call to this new service.
- The new service may need to call back into the `MappingExecutor` or its sub-services to run the reverse mapping, so the dependency structure should be carefully designed.
- All tests related to bidirectional validation must pass.

## 5. Implementation Requirements
- **Input files/data:** `mapping_executor.py`
- **Expected outputs:** A new service file (e.g., `biomapper/core/services/bidirectional_validation_service.py`) and a modified `mapping_executor.py`.
- **Code standards:** Pay attention to dependency injection to avoid circular dependencies if the new service needs to invoke mapping functionality.

## 6. Error Recovery Instructions
- The main risk is creating a circular dependency. If the `BidirectionalValidationService` needs to run a mapping, it should likely call a public method on the `MappingExecutor` rather than trying to replicate the logic internally. Ensure this interaction is clean.
- Test failures will likely indicate that the validation results are different. This could be due to incorrect state being passed to the validation service.

## 7. Feedback and Reporting
- **File Path:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/feedback/YYYY-MM-DD-HHMMSS-feedback-refactor-executor-bidirectional-validation.md`
- **Content:**
    - **Completed Subtasks:** Detail the creation of the validation service and the changes in `MappingExecutor`.
    - **Issues Encountered:** Describe any challenges with circular dependencies or state management.
    - **Next Action Recommendation:** Confirm the successful modularization of this feature.
    - **Confidence Assessment:** Medium. The potential for circular dependencies requires careful design.
# Task: Decompose Initial Direct Mapping from `execute_mapping`

## 1. Task Objective
Extract the initial 'direct mapping' logic from the beginning of the `MappingExecutor.execute_mapping` method into a new, dedicated service class. This is the first step in breaking down the monolithic `execute_mapping` method.

## 2. Context and Background
The `execute_mapping` method in `biomapper/core/mapping_executor.py` is over 600 lines long. The first major block of logic in this method attempts to perform a direct mapping between the source and target using a primary shared ontology. This self-contained logic is an ideal candidate for extraction.

## 3. Key Memories and Documents
- **Source File:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/mapping_executor.py`
- **Starter Prompt:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/_starter_prompt.md`

## 4. Success Criteria
- A new service class (e.g., `DirectMappingService`) is created in a new file under `biomapper/core/services/`.
- The new service has a primary public method (e.g., `execute_direct_mapping`) that encapsulates the logic for finding and executing a direct mapping path.
- The `MappingExecutor.execute_mapping` method is updated to call this new service.
- The logic removed from `execute_mapping` should make it noticeably smaller and easier to read.
- All related integration tests must pass, demonstrating that the refactored logic behaves identically to the original.

## 5. Implementation Requirements
- **Input files/data:** `mapping_executor.py`
- **Expected outputs:** A new service file (e.g., `biomapper/core/services/direct_mapping_service.py`) and a modified `mapping_executor.py`.
- **Code standards:** Follow existing project conventions for creating new service classes. Use asynchronous methods and dependency injection.

## 6. Error Recovery Instructions
- Pay close attention to the data contract between the `MappingExecutor` and the new service. Ensure all necessary data (identifiers, session, endpoints) is passed correctly and the return values (mapped/unmapped results) are handled properly.
- If tests fail, verify that the extracted logic in the new service is identical to the original logic and that it's being called correctly from the executor.

## 7. Feedback and Reporting
- **File Path:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/feedback/YYYY-MM-DD-HHMMSS-feedback-refactor-executor-direct-mapping.md`
- **Content:**
    - **Completed Subtasks:** Note the creation of the new service and the modification of `execute_mapping`.
    - **Issues Encountered:** Describe any difficulties in isolating the direct mapping logic.
    - **Next Action Recommendation:** Confirm readiness for the next `execute_mapping` decomposition task.
    - **Confidence Assessment:** High. This is a well-contained piece of logic.
# Task: Decompose Bidirectional Validation from `execute_mapping`

## 1. Task Objective
Extract the logic for bidirectional validation from the `MappingExecutor.execute_mapping` method into a new, self-contained service. This service will handle the process of re-running mappings in the reverse direction to validate the initial results.

## 2. Context and Background
Within the large `execute_mapping` method, there is a conditional block that, if `bidirectional_validation` is enabled, triggers a recursive or secondary mapping process in the reverse direction. This is a distinct and complex feature that should reside in its own specialized service.

## 3. Key Memories and Documents
- **Source File:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/mapping_executor.py`
- **Starter Prompt:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/_starter_prompt.md`

## 4. Success Criteria
- A new service class (e.g., `BidirectionalValidationService`) is created in a new file under `biomapper/core/services/`.
- The service encapsulates the logic for performing the reverse mapping and comparing the results against the forward mapping.
- The `MappingExecutor.execute_mapping` method is simplified by replacing the inline validation logic with a call to this new service.
- The new service may need to call back into the `MappingExecutor` or its sub-services to run the reverse mapping, so the dependency structure should be carefully designed.
- All tests related to bidirectional validation must pass.

## 5. Implementation Requirements
- **Input files/data:** `mapping_executor.py`
- **Expected outputs:** A new service file (e.g., `biomapper/core/services/bidirectional_validation_service.py`) and a modified `mapping_executor.py`.
- **Code standards:** Pay attention to dependency injection to avoid circular dependencies if the new service needs to invoke mapping functionality.

## 6. Error Recovery Instructions
- The main risk is creating a circular dependency. If the `BidirectionalValidationService` needs to run a mapping, it should likely call a public method on the `MappingExecutor` rather than trying to replicate the logic internally. Ensure this interaction is clean.
- Test failures will likely indicate that the validation results are different. This could be due to incorrect state being passed to the validation service.

## 7. Feedback and Reporting
- **File Path:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/feedback/YYYY-MM-DD-HHMMSS-feedback-refactor-executor-bidirectional-validation.md`
- **Content:**
    - **Completed Subtasks:** Detail the creation of the validation service and the changes in `MappingExecutor`.
    - **Issues Encountered:** Describe any challenges with circular dependencies or state management.
    - **Next Action Recommendation:** Confirm the successful modularization of this feature.
    - **Confidence Assessment:** Medium. The potential for circular dependencies requires careful design.
# Task: Refactor MappingExecutor Initialization Logic

## 1. Task Objective
To simplify the `MappingExecutor` constructor (`__init__`) and asynchronous factory (`create`) by delegating the responsibility of component initialization and dependency injection to the existing `MappingExecutorInitializer` service. This will reduce the parameter count of the executor's constructor and centralize the setup logic, improving maintainability.

## 2. Context and Background
`biomapper/core/mapping_executor.py` is overly complex, with its `__init__` method taking a large number of parameters for configuration and component setup. An initializer class, `MappingExecutorInitializer`, already exists in `biomapper/core/engine_components/mapping_executor_initializer.py` but is not being fully utilized. This task is to complete the delegation of initialization logic to this service.

## 3. Key Memories and Documents
- **Source File:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/mapping_executor.py`
- **Target Service:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/engine_components/mapping_executor_initializer.py`
- **Starter Prompt:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/_starter_prompt.md`

## 4. Success Criteria
- The `MappingExecutor.__init__` method's parameter list is significantly reduced. It should primarily accept pre-initialized service components, not configuration values.
- The `MappingExecutorInitializer` is responsible for creating instances of `ClientManager`, `ConfigLoader`, `StrategyHandler`, `PathFinder`, `CheckpointManager`, etc.
- The `MappingExecutor.create` static method uses `MappingExecutorInitializer` to build the executor instance.
- All existing tests related to `MappingExecutor` instantiation must pass after the refactoring.

## 5. Implementation Requirements
- **Input files/data:** `mapping_executor.py`, `mapping_executor_initializer.py`
- **Expected outputs:** Modified versions of the input files.
- **Code standards:** Adhere to existing project formatting, use type hints, and ensure all logic is asynchronous where appropriate.

## 6. Error Recovery Instructions
- If you encounter import errors, ensure all new service dependencies are correctly imported.
- If tests fail, it is likely due to incorrect dependency injection. Trace the creation of the failed component back to the `MappingExecutorInitializer` and ensure it's being constructed with the correct parameters.

## 7. Feedback and Reporting
- **File Path:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/feedback/YYYY-MM-DD-HHMMSS-feedback-refactor-executor-initialization.md`
- **Content:**
    - **Completed Subtasks:** Checklist of modifications made to `MappingExecutor` and `MappingExecutorInitializer`.
    - **Issues Encountered:** Document any challenges with dependency injection or test failures.
    - **Next Action Recommendation:** Suggest any further cleanup related to initialization.
    - **Confidence Assessment:** High. This is a structural refactoring with clear boundaries.
# Task: Refactor Execution Lifecycle Management

## 1. Task Objective
To decouple the `MappingExecutor` from the direct management of execution lifecycle concerns like checkpointing, progress reporting, and metrics. This will be achieved by creating a new, high-level service that coordinates these aspects, further simplifying the executor.

## 2. Context and Background
The `MappingExecutor` currently has several delegate methods for saving/loading checkpoints (`save_checkpoint`, `load_checkpoint`) and reporting progress (`_report_progress`). While these delegate to other managers, they still clutter the executor's interface. Consolidating these into a single `ExecutionLifecycleService` would provide a cleaner separation of concerns.

## 3. Key Memories and Documents
- **Source File:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/mapping_executor.py`
- **Component Managers:** `CheckpointManager`, `ProgressReporter`.
- **Starter Prompt:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/_starter_prompt.md`

## 4. Success Criteria
- A new `ExecutionLifecycleService` is created in `biomapper/core/services/`.
- This service is initialized with the `CheckpointManager`, `ProgressReporter`, and potentially a new `MetricsManager`.
- The delegate methods for checkpointing and progress reporting are removed from `MappingExecutor`.
- The `MappingExecutor` calls the new `ExecutionLifecycleService` at appropriate points (e.g., `lifecycle_service.report_progress(...)`).
- The `MappingExecutor`'s public API is cleaner and more focused on mapping orchestration.
- All tests related to checkpointing and progress reporting must pass.

## 5. Implementation Requirements
- **Input files/data:** `mapping_executor.py`, and the paths to the component manager classes.
- **Expected outputs:** A new service file (e.g., `biomapper/core/services/execution_lifecycle_service.py`) and a modified `mapping_executor.py`.
- **Code standards:** The new service should be injected into the `MappingExecutor` during initialization.

## 6. Error Recovery Instructions
- If tests fail, it's likely because a call to a lifecycle method (like reporting progress) was missed during the refactoring. Review the original `execute_mapping` and `execute_strategy` methods to ensure all original calls are now being made via the new service.

## 7. Feedback and Reporting
- **File Path:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/feedback/YYYY-MM-DD-HHMMSS-feedback-refactor-executor-lifecycle-management.md`
- **Content:**
    - **Completed Subtasks:** Describe the creation of the new service and the removal of delegate methods from the executor.
    - **Issues Encountered:** Note any difficulties in deciding the boundaries of the new service.
    - **Next Action Recommendation:** Confirm that the executor is now sufficiently decoupled from lifecycle concerns.
    - **Confidence Assessment:** High. This refactoring helps to enforce better separation of concerns.
