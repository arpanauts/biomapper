# Task 4: Create `DatabaseSetupService`
# Task: Resolve MetricsTracker Initialization Errors

## Context:
A significant number of tests are failing with `TypeError: MetricsTracker.__init__() got an unexpected keyword argument 'enable_metrics'`. This suggests a recent change in the `MetricsTracker` class's constructor or how it's being instantiated across the codebase.

## Objective:
Identify the cause of the `TypeError` related to `MetricsTracker` and correct all instances where it's being called or defined incorrectly.

## Affected Tests:
The following tests are failing with this specific error. Investigate the `MetricsTracker` instantiation in these test setups or the code they exercise:

- `tests/test_yaml_strategy_provenance.py::TestYAMLStrategyProvenanceTracking::test_trace_mapping_chain_simple`
- `tests/core/test_bidirectional_mapping_optimization.py::TestBidirectionalMappingOptimization::test_path_caching`
- `tests/core/test_bidirectional_mapping_optimization.py::TestBidirectionalMappingOptimization::test_concurrent_batch_processing`
- `tests/core/test_bidirectional_mapping_optimization.py::TestBidirectionalMappingOptimization::test_metrics_tracking`
- `tests/core/test_bidirectional_mapping_optimization.py::TestIntegrationOptimizedBidirectionalMapping::test_end_to_end_mapping`
- `tests/integration/test_yaml_strategy_ukbb_hpa.py::test_full_yaml_strategy_workflow`
- `tests/mapping/test_reverse_mapping.py::test_reverse_mapping`
- `tests/unit/core/test_mapping_executor_robust_features.py::TestCheckpointing::test_checkpoint_directory_creation`
- `tests/core/test_mapping_executor_metadata.py::test_metadata_in_cache_results`
- `tests/core/test_metadata_population.py::test_cache_results_populates_metadata_fields`
- `tests/core/test_metadata_population.py::test_confidence_score_calculation`
- `tests/core/test_metadata_population.py::test_mapping_path_details_contents`
- `tests/core/test_metadata_population.py::test_cache_results_handles_errors`
- `tests/integration/test_historical_id_mapping.py::TestHistoricalIDMapping::test_mapping_with_historical_resolution`
- `tests/integration/test_historical_id_mapping.py::TestHistoricalIDMapping::test_path_selection_order`
- `tests/integration/test_historical_id_mapping.py::TestHistoricalIDMapping::test_cache_usage`
- `tests/integration/test_historical_id_mapping.py::TestHistoricalIDMapping::test_error_handling`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_basic_linear_strategy`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_strategy_with_execute_mapping_path`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_strategy_with_filter_action`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_mixed_action_strategy`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_strategy_not_found`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_empty_initial_identifiers`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_step_failure_handling`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_ontology_type_tracking`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_filter_with_conversion_path`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_strategy_with_conditional_branching`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_parallel_action_execution`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_all_optional_strategy`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_mixed_required_optional_strategy`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_optional_fail_first_strategy`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_optional_fail_last_strategy`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_multiple_optional_failures_strategy`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_required_fail_after_optional_strategy`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_all_optional_fail_strategy`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_required_step_explicit_true`
- `tests/integration/test_yaml_strategy_execution.py::TestYAMLStrategyExecution::test_mapping_result_bundle_tracking`
- `tests/integration/test_yaml_strategy_ukbb_hpa.py::TestUKBBToHPAYAMLStrategy::test_strategy_loaded_in_database`
- `tests/integration/test_yaml_strategy_ukbb_hpa.py::TestUKBBToHPAYAMLStrategy::test_execute_yaml_strategy_basic`
- `tests/integration/test_yaml_strategy_ukbb_hpa.py::TestUKBBToHPAYAMLStrategy::test_execute_yaml_strategy_with_invalid_strategy`
- `tests/integration/test_yaml_strategy_ukbb_hpa.py::TestUKBBToHPAYAMLStrategy::test_execute_yaml_strategy_with_progress_callback`
- `tests/integration/test_yaml_strategy_ukbb_hpa.py::TestUKBBToHPAYAMLStrategy::test_action_handlers_placeholder_behavior`

## Tasks:
1.  Review the `MetricsTracker` class definition, specifically its `__init__` method.
2.  Identify if the `enable_metrics` parameter was recently added, removed, or renamed.
3.  Update all instantiation points of `MetricsTracker` (both in application code and test code) to match the correct constructor signature.
4.  Ensure that the logic related to `enable_metrics` (if it's a valid parameter) is handled correctly within `MetricsTracker`.

## Expected Outcome:
All listed tests should pass, and the `TypeError` related to `MetricsTracker` initialization should be resolved globally.
# Task 3: Refactor `MappingExecutor` to a Lean Facade

## Objective
Extract the database schema initialization logic from `MappingExecutor` into a new, single-purpose `DatabaseSetupService`. This service will be responsible for creating database tables, ensuring a clean separation between application runtime and database management/setup tasks.

## Rationale
Database schema creation is a setup concern, not a runtime execution concern. Mixing it into `MappingExecutor` complicates the class and violates the Single Responsibility Principle. A dedicated service makes the setup process explicit and reusable, and it can be invoked independently of the main application logic if needed (e.g., in deployment scripts or standalone setup tools).

## New Component Location
- Create a new file: `biomapper/core/services/database_setup_service.py`
- Define the class: `DatabaseSetupService`

## Core Responsibilities of `DatabaseSetupService`
- Connect to a database using a provided engine.
- Check if the required tables already exist.
- Create all tables defined in a given SQLAlchemy `Base` metadata object if they do not exist.

## Methods to Move/Refactor from `MappingExecutor`

The following method should be moved from `MappingExecutor` to `DatabaseSetupService`:

1.  `_init_db_tables`: This method contains the entire logic for checking for and creating tables. It will become the primary method of the new service.

## `DatabaseSetupService` `__init__`
The constructor can be simple, primarily accepting a logger:
- `logger`

## Refactoring Steps
1.  **Create the File and Class:** Create `biomapper/core/services/database_setup_service.py` and define the `DatabaseSetupService` class.
2.  **Move `_init_db_tables`:**
    - Move the `_init_db_tables` method from `MappingExecutor` to `DatabaseSetupService`.
    - Rename it to something more public, like `async def initialize_tables(self, engine, base_metadata)`. Make it a public method of the service.
3.  **Update `MappingExecutor.create`:**
    - In the `MappingExecutor.create` class method, instantiate the new `DatabaseSetupService`.
    - Instead of calling `await executor._init_db_tables(...)` for both the metamapper and cache databases, you will now call:
      ```python
      db_setup_service = DatabaseSetupService(logger=executor.logger)
      await db_setup_service.initialize_tables(executor.async_metamapper_engine, MetamapperBase.metadata)
      await db_setup_service.initialize_tables(executor.async_cache_engine, CacheBase.metadata)
      ```
    - (Note: You'll need to ensure `MetamapperBase` is imported or accessible).
4.  **Remove from `MappingExecutor`:** Delete the `_init_db_tables` method from the `MappingExecutor` class.
With the core logic now extracted into `MappingPathExecutionService` and `StrategyExecutionService`, refactor the `MappingExecutor` class to serve as a lean, clean facade. Its primary responsibilities will be initialization of components and delegation of tasks to the appropriate services.

## Rationale
This final step in the deconstruction completes the separation of concerns. A lean `MappingExecutor` is easier to understand, as its public API clearly shows the main capabilities of the system (e.g., `map`, `execute_strategy`) without exposing the complex implementation details, which now reside in the specialized services.

## Refactoring Steps

1.  **Review `MappingExecutor.__init__`:**
    - The initializer should now be primarily responsible for instantiating all the engine components and services:
        - `SessionManager`, `ClientManager`, `CacheManager`, etc.
        - The new `MappingPathExecutionService` and `StrategyExecutionService`.
    - Pass the necessary dependencies into the constructors of the new services.
    - Remove any attributes from `self` that are no longer directly used by `MappingExecutor` itself (e.g., if a component is only used by one of the new services, it might not need to be an attribute of `MappingExecutor`).

2.  **Simplify the Public API:**
    - The main public methods of `MappingExecutor` should be high-level entry points. Review and refine:
        - `execute_mapping`: This method should now use `self.path_finder` to find a path and then delegate the execution to `self.path_execution_service`.
        - `execute_strategy`: This method should be a simple pass-through to `self.strategy_execution_service`.
        - `map`: This should be the primary, user-friendly method. It might internally decide whether to call `execute_mapping` or `execute_strategy` based on its arguments.

3.  **Remove Redundant/Pass-Through Methods:**
    - `MappingExecutor` currently has several private methods that are simple pass-through calls to `PathFinder` (e.g., `_find_mapping_paths`, `_find_best_path`) or `MetadataQueryService`.
    - These should be removed from `MappingExecutor`. Components or services that need this functionality should be given a direct dependency on `PathFinder` or `MetadataQueryService` instead of going through `MappingExecutor`.

4.  **Update `MappingExecutor.create` Factory:**
    - Ensure the asynchronous factory method `create` correctly initializes the simplified `MappingExecutor` and all its dependent services.
    - The call to `_init_db_tables` should be replaced by a call to the new `DatabaseSetupService` (from Prompt 4).

## Acceptance Criteria
- The new `DatabaseSetupService` is created and contains the logic for initializing database schemas.
- The `_init_db_tables` method is completely removed from `MappingExecutor`.
- The `MappingExecutor.create` factory method successfully uses the new `DatabaseSetupService` to set up the databases upon instantiation.
- The application continues to start up correctly, and tests that rely on database setup still pass, confirming that the tables are being created as expected.
- `MappingExecutor` is significantly shorter and simpler. Its `__init__` method is focused on dependency injection.
- The public API of `MappingExecutor` is clean and delegates all heavy lifting to the appropriate services (`MappingPathExecutionService`, `StrategyExecutionService`).
- Redundant private helper and pass-through methods have been removed.
- All dependent components are correctly initialized and wired together.
- High-level integration tests continue to pass, demonstrating that the facade correctly orchestrates the underlying services.
