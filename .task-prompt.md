# Task: Decompose MappingExecutor's Execution Logic into Focused Services

## 1. Objective

Further refactor the oversized `MappingExecutor` class by extracting its main execution methods (`execute_mapping`, `execute_strategy`, and `execute_yaml_strategy`) into new, separate, and focused service classes. The goal is to dramatically reduce the size and complexity of `MappingExecutor`, enforcing the Single Responsibility Principle and turning it into a pure facade.

## 2. Context and Background

While previous refactoring has successfully delegated much of the internal logic of `MappingExecutor` to various services, the class itself remains over 2,000 lines long. This is because it still contains the high-level orchestration logic for three distinct mapping execution paradigms. This violates software design best practices and makes the class difficult to maintain and understand.

This task continues our modularization effort by isolating each execution workflow into its own service, leaving `MappingExecutor` with the sole responsibility of delegating incoming requests to the correct service.

## 3. Prerequisites

- The agent must be familiar with the ongoing service-oriented refactoring of the Biomapper project.
- All necessary services that these new execution services will depend on (e.g., `PathFinder`, `ClientManager`, `ResultAggregationService`) already exist and are injected into `MappingExecutor`.

## 4. Task Breakdown

1.  **Create New Service Classes:**
    - In the `biomapper/core/services/` directory, create a new file named `execution_services.py`.
    - Inside this new file, define three new service classes:
        - `IterativeExecutionService`: This class will contain the logic currently in `MappingExecutor.execute_mapping`.
        - `DbStrategyExecutionService`: This class will contain the logic from `MappingExecutor.execute_strategy`.
        - `YamlStrategyExecutionService`: This class will contain the logic from `MappingExecutor.execute_yaml_strategy`.

2.  **Implement Service Constructors:**
    - Each new service will require access to other existing services (e.g., `PathFinder`, `ClientManager`, `LifecycleService`, etc.).
    - The constructor for each new service (`__init__`) should accept these required services as arguments.

3.  **Move Logic to New Services:**
    - Cut the entire method body from `MappingExecutor.execute_mapping` and paste it into a new `execute` method within `IterativeExecutionService`.
    - Repeat this process for `MappingExecutor.execute_strategy` -> `DbStrategyExecutionService.execute`.
    - Repeat for `MappingExecutor.execute_yaml_strategy` -> `YamlStrategyExecutionService.execute`.
    - Carefully refactor the moved code to use the services passed into the constructor (e.g., `self.path_finder` instead of `executor.path_finder`).

4.  **Refactor `MappingExecutor`:**
    - In `MappingExecutor.__init__`, instantiate the three new execution services, passing the necessary dependencies (`self.path_finder`, `self.client_manager`, etc.).
    - Replace the original, large `execute_mapping`, `execute_strategy`, and `execute_yaml_strategy` methods with new, lightweight versions that do nothing but delegate the call to the appropriate new service. For example:
      ```python
      async def execute_mapping(self, *args, **kwargs):
          return await self.iterative_execution_service.execute(*args, **kwargs)
      ```

5.  **Update `__init__.py`:**
    - Add the new service classes to `biomapper/core/services/__init__.py` to ensure they are correctly exported.
# Task: Fix `TypeError` in `execute_yaml_strategy` Method

## 1. Objective

Resolve the critical runtime bug `TypeError: MappingExecutor.execute_yaml_strategy() got an unexpected keyword argument 'initial_context'`. The fix involves updating the method's signature to accept dynamic context parameters, which is essential for our newly refactored, flexible pipeline execution.

## 2. Context and Background

We recently refactored the main pipeline script (`run_full_ukbb_hpa_mapping.py`) to invoke a self-contained YAML strategy. As part of this refactoring, the script now passes an `initial_context` dictionary to the `MappingExecutor.execute_yaml_strategy` method. This dictionary is intended to carry runtime parameters, such as the output directory for saving results.

However, the pipeline currently fails immediately with a `TypeError` because the method signature for `execute_yaml_strategy` was not updated to accept this new `initial_context` argument. This task is to correct that oversight.

## 3. Prerequisites

- The agent must understand the role of `MappingExecutor` and how it executes YAML-defined strategies.
- The target file for this fix is `biomapper/core/mapping_executor.py`.

## 4. Task Breakdown

1.  **Locate the `execute_yaml_strategy` method** within `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/mapping_executor.py`.
2.  **Update the Method Signature:**
    - Add a new optional parameter to the method definition: `initial_context: Optional[Dict[str, Any]] = None`.
3.  **Integrate the Initial Context:**
    - Inside the method, locate where the `execution_context` dictionary is initialized.
    - If `initial_context` is provided (i.e., not `None`), merge its contents into the main `execution_context`. The initial context should take precedence if there are any key conflicts.
    - A simple way to do this is:
      ```python
      execution_context = {}
      if initial_context:
          execution_context.update(initial_context)
      ```
      Ensure this is placed correctly before the strategy's steps are executed.

## 5. Implementation Requirements

- **Input Files:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/mapping_executor.py`
- **Expected Outputs:**
    - A new file: `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/services/execution_services.py`
    - A significantly smaller and simplified `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/mapping_executor.py`.
    - An updated `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/services/__init__.py`.
- **Code Standards:** All new code must be fully type-hinted and follow async/await patterns. Maintain existing code style.

- **Input File:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/mapping_executor.py`
- **Expected Outputs:** The modified `mapping_executor.py` file with the bug fix applied.
- **Code Standards:** Maintain existing code style, including full type hinting.

## 6. Error Recovery Instructions

- **Dependency Errors:** You may encounter `AttributeError` if a service method tries to access a component that wasn't passed into its constructor. Carefully trace the dependencies and ensure all required services are injected correctly.
- **Import Errors:** Ensure all new classes are correctly imported in `MappingExecutor` and correctly exported from the services package `__init__.py`.

## 7. Validation and Success Criteria

- The primary success criterion is that all existing tests must pass after the refactoring.
- Run the full test suite using `poetry run pytest` from the project root.
- The `MappingExecutor` file should be reduced in size by at least 50%.
- The new `execution_services.py` file should be created and contain the extracted logic.

## 8. Feedback and Reporting

- Provide the `diff` of the changes made to `mapping_executor.py`.
- Provide the full content of the new `execution_services.py` file.
- Confirm that all tests passed successfully.

- **`TypeError` Persists:** If the error continues, double-check that you have modified the correct method signature and that there are no other layers (e.g., wrapper methods) that are blocking the parameter from being passed through.
- **`AttributeError`:** If you encounter an `AttributeError`, it may indicate that the context is not being passed correctly to the underlying `StrategyExecutionService`. Ensure the `execution_context` is properly updated and passed in the service call.

## 7. Validation and Success Criteria

- **Primary Validation:** The fix is considered successful when the main pipeline script can be executed without the `TypeError`.
- **Execution Command:** Run the following command from the project root (`/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/`):
  ```bash
  poetry run python scripts/main_pipelines/run_full_ukbb_hpa_mapping.py
  ```
- **Expected Outcome:** The script should start, and the log output should show the strategy execution beginning, without the immediate crash we saw previously.

## 8. Feedback and Reporting

- Provide the `diff` of the changes made to `mapping_executor.py`.
- Confirm that you ran the validation command and that the `TypeError` is resolved.
- Provide the first 20-30 lines of the log output from the successful run to show the pipeline is progressing.
