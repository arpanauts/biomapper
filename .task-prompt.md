# Task: Fix Widespread AssertionErrors in `test_mapping_executor.py`

## Task Objective

Your task is to fix a large number of failing tests in `/home/ubuntu/biomapper/tests/core/test_mapping_executor.py`. These tests are all failing with `AssertionError` and indicate a systemic issue with how mocked objects are configured in the test suite.

## Prerequisites

-   You have access to the `biomapper` codebase at `/home/ubuntu/biomapper/`.
-   Poetry environment is set up and dependencies are installed.

## Input Context

-   **Failing Test File:** `/home/ubuntu/biomapper/tests/core/test_mapping_executor.py`
-   **Primary Issue:** The tests are asserting the status of a result, but the mocked methods are returning a `MagicMock` object instead of a dictionary. For example: `AssertionError: assert <MagicMock name='mock().__getitem__()' id='...'> == 'success'`
-   **List of Failing Tests:**
    -   `test_execute_mapping_empty_input`
    -   `test_execute_path_integration`
    -   `test_execute_path_error_handling`
    -   `test_handle_convert_identifiers_local_success`
    -   `test_handle_convert_identifiers_local_fallback`
    -   `test_handle_convert_identifiers_local_missing_output_type`
    -   `test_handle_execute_mapping_path_success`
    -   `test_handle_execute_mapping_path_fallback`
    -   `test_handle_execute_mapping_path_missing_path`
    -   `test_handle_filter_identifiers_by_target_presence_success`
    -   `test_handle_filter_identifiers_by_target_presence_fallback`

## Expected Outputs

-   Modified `/home/ubuntu/biomapper/tests/core/test_mapping_executor.py` with corrected mock configurations.
-   All the listed tests should run without assertion errors.

## Success Criteria

-   Running `poetry run pytest /home/ubuntu/biomapper/tests/core/test_mapping_executor.py` shows that all the listed tests now pass. Other test results should remain unaffected.

## Error Recovery Instructions

-   If fixing the mocks reveals deeper issues in the `MappingExecutor`'s logic, document these findings and propose a plan for addressing them.

## Environment Requirements

-   A working `poetry` environment for the `biomapper` project.
-   Access to the project files.

## Task Decomposition

1.  **Identify the Pattern:**
    -   The core problem is that when a method is mocked (e.g., using `patch` or `AsyncMock`), its return value is a `MagicMock` by default. The tests, however, expect a dictionary with a `'status'` key (e.g., `{'status': 'success', ...}`).

2.  **Correct the Mocks:**
    -   For each failing test, locate the `mock_action.execute.return_value` or similar mock setup.
    -   Change the `return_value` to be a dictionary that includes the expected status and any other necessary data. For example:
        ```python
        # Instead of this:
        # mock_action.execute.return_value = AsyncMock()

        # Do this:
        mock_action.execute.return_value = {'status': 'success', 'output_identifiers': ['...'], 'details': {}}
        ```
    -   Pay close attention to what each test asserts to ensure the mock returns the correct structure.

3.  **Address `test_execute_mapping_empty_input`:**
    -   This test fails with `AssertionError: expected call not found`. This means a mocked method was expected to be called but wasn't. Review the logic in `MappingExecutor.execute_mapping` to understand what should happen when `identifiers` is empty and adjust the test's expectations accordingly.

4.  **Address `test_execute_path_integration` and `test_execute_path_error_handling`:**
    -   These tests also fail due to assertion errors related to mock calls. Ensure the mocked `_run_path_steps` method is configured to return a dictionary that matches the structure expected by the test assertions.

5.  **Validate Fixes:**
    -   Run `poetry run pytest /home/ubuntu/biomapper/tests/core/test_mapping_executor.py` and confirm all the listed tests pass.

## Validation Checkpoints

-   After fixing a group of related tests (e.g., all the `_handle_convert_identifiers_*` tests), run them to verify the fix.
-   Before finishing, run the full test suite for `test_mapping_executor.py` to ensure no regressions were introduced.

## Source Prompt Reference

-   `/home/ubuntu/biomapper/roadmap/_active_prompts/2025-06-23-220824-fix-assertion-errors.md`

## Context from Previous Attempts

-   This is the first attempt to fix these specific test failures.

# Task: Fix Failing Cache-Related Tests in `test_mapping_executor.py`

## Task Objective

Your task is to fix two failing tests in `/home/ubuntu/biomapper/tests/core/test_mapping_executor.py`: `test_check_cache_unexpected_error` and `test_cache_results_db_error_during_commit`. The goal is to ensure these tests pass successfully when running `poetry run pytest /home/ubuntu/biomapper/tests/core/test_mapping_executor.py`.

## Prerequisites

-   You have access to the `biomapper` codebase at `/home/ubuntu/biomapper/`.
-   Poetry environment is set up and dependencies are installed.

## Input Context

-   **Failing Test File:** `/home/ubuntu/biomapper/tests/core/test_mapping_executor.py`
-   **File Under Test:** `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`
-   **Relevant Component:** `biomapper.core.engine_components.cache_manager.CacheManager`
-   **Pytest Output Snippet:**

    ```
    FAILED tests/core/test_mapping_executor.py::test_check_cache_unexpected_error - TypeError: CacheError.__init__() missing 1 requir...
    FAILED tests/core/test_mapping_executor.py::test_cache_results_db_error_during_commit - AttributeError: 'CacheManager' object has no attr...
    ```

-   **Failing Test Code:**

    -   `test_check_cache_unexpected_error` (starts line 944)
    -   `test_cache_results_db_error_during_commit` (starts line 982)

## Expected Outputs

-   Modified `/home/ubuntu/biomapper/tests/core/test_mapping_executor.py` and potentially `/home/ubuntu/biomapper/biomapper/core/engine_components/cache_manager.py` or `/home/ubuntu/biomapper/biomapper/core/exceptions.py` to make the tests pass.
-   The two specified tests should run without errors.

## Success Criteria

-   Running the command `poetry run pytest /home/ubuntu/biomapper/tests/core/test_mapping_executor.py` shows that `test_check_cache_unexpected_error` and `test_cache_results_db_error_during_commit` now pass. Other test results should remain unaffected.

## Error Recovery Instructions

-   If the fix requires changes to other parts of the caching logic, analyze the dependencies and document the required changes. If the changes are extensive, report back with a plan before implementing.

## Environment Requirements

-   A working `poetry` environment for the `biomapper` project.
-   Access to the project files.

## Task Decomposition

1.  **Analyze `test_check_cache_unexpected_error`:**
    -   Examine the `TypeError`. It seems the `CacheError` exception is not being instantiated correctly in the test or the `CacheManager`.
    -   Review the `CacheError` class definition in `/home/ubuntu/biomapper/biomapper/core/exceptions.py` to understand its `__init__` signature.
    -   Correct the instantiation of `CacheError` in the test or the code it's testing.

2.  **Analyze `test_cache_results_db_error_during_commit`:**
    -   Examine the `AttributeError`. The test is trying to access an attribute that does not exist on the `CacheManager` object.
    -   Review the `CacheManager` implementation to understand its available methods and attributes.
    -   Modify the test to use the correct methods/attributes of the `CacheManager`.

3.  **Validate Fixes:**
    -   Run `poetry run pytest /home/ubuntu/biomapper/tests/core/test_mapping_executor.py` and confirm the two tests pass.

## Validation Checkpoints

-   After fixing each test, run it individually to ensure it passes.
-   Before finishing, run the full test suite for `test_mapping_executor.py` to ensure no regressions were introduced.

## Source Prompt Reference

-   `/home/ubuntu/biomapper/roadmap/_active_prompts/2025-06-23-220824-fix-cache-tests.md`

## Context from Previous Attempts

-   This is the first attempt to fix these specific test failures.
