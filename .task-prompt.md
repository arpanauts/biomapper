# Task: Create LifecycleManager

**Source Prompt Reference:** This task is defined by the prompt: `/home/ubuntu/biomapper/roadmap/_active_prompts/2025-06-22-171744-prompt-create-lifecycle-manager.md`

## 1. Task Objective
Create a new `LifecycleManager` service in `/home/ubuntu/biomapper/biomapper/core/engine_components/lifecycle_manager.py`. This service will consolidate all lifecycle-related operations from `MappingExecutor`, including resource disposal, checkpoint management, and progress reporting.

## 2. Prerequisites
- [x] Required files exist: `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`.
- [x] Required permissions: Write access to `/home/ubuntu/biomapper/biomapper/core/engine_components/`.

## 3. Task Decomposition
1.  **Create the new file:** Create `/home/ubuntu/biomapper/biomapper/core/engine_components/lifecycle_manager.py`.
2.  **Define `LifecycleManager` class:** This class will be initialized with dependencies like `SessionManager` and the existing `ExecutionLifecycleService`.
3.  **Move `async_dispose`:** Move the logic from `MappingExecutor.async_dispose` to the new service.
4.  **Move Checkpointing Logic:** Move the `checkpoint_dir` property (getter and setter), `save_checkpoint`, and `load_checkpoint` methods to the new service.
5.  **Move Progress Reporting:** Move the `_report_progress` method to the new service and make it public (`report_progress`).
6.  **Add necessary imports.**
# Task: Create MappingCoordinatorService

**Source Prompt Reference:** This task is defined by the prompt: `/home/ubuntu/biomapper/roadmap/_active_prompts/2025-06-22-171743-prompt-create-mapping-coordinator-service.md`

## 1. Task Objective
Create a new `MappingCoordinatorService` in `/home/ubuntu/biomapper/biomapper/core/engine_components/mapping_coordinator_service.py`. This service will consolidate the high-level mapping orchestration logic from `MappingExecutor`, specifically the `execute_mapping` and `_execute_path` methods.

## 2. Prerequisites
- [x] Required files exist: `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`.
- [x] Required permissions: Write access to `/home/ubuntu/biomapper/biomapper/core/engine_components/`.

## 3. Task Decomposition
1.  **Create the new file:** Create `/home/ubuntu/biomapper/biomapper/core/engine_components/mapping_coordinator_service.py`.
2.  **Define `MappingCoordinatorService` class:** This class will be initialized with dependencies like `IterativeExecutionService` and `MappingPathExecutionService`.
3.  **Move `execute_mapping`:** Move the `MappingExecutor.execute_mapping` method and its logic to the new service.
4.  **Move `_execute_path`:** Move the `MappingExecutor._execute_path` method and its logic to the new service. Rename it to `execute_path` to make it a public method of the service.
5.  **Add necessary imports:** Copy all required imports to the new file.
# Task: Create StrategyCoordinatorService

**Source Prompt Reference:** This task is defined by the prompt: `/home/ubuntu/biomapper/roadmap/_active_prompts/2025-06-22-171742-prompt-create-strategy-coordinator-service.md`

## 1. Task Objective
Create a new `StrategyCoordinatorService` in `/home/ubuntu/biomapper/biomapper/core/engine_components/strategy_coordinator_service.py`. This service will consolidate all strategy execution logic from `MappingExecutor`, providing a single, clean interface for running database-backed, YAML-defined, and robust strategies.

## 2. Prerequisites
- [x] Required files exist: `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py` and the various execution services it calls.
- [x] Required permissions: Write access to `/home/ubuntu/biomapper/biomapper/core/engine_components/`.

## 3. Task Decomposition
1.  **Create the new file:** Create `/home/ubuntu/biomapper/biomapper/core/engine_components/strategy_coordinator_service.py`.
2.  **Define `StrategyCoordinatorService` class:** Create the class. It should be initialized with the necessary dependencies it needs to orchestrate strategy execution (e.g., `DbStrategyExecutionService`, `YamlStrategyExecutionService`, `RobustExecutionCoordinator`).
3.  **Move `execute_strategy`:** Move the logic from `MappingExecutor.execute_strategy` into a method in the new service.
4.  **Move `execute_yaml_strategy`:** Move the logic from `MappingExecutor.execute_yaml_strategy` into a method in the new service.
5.  **Move `execute_robust_yaml_strategy`:** Move the logic from `MappingExecutor.execute_robust_yaml_strategy` into a method in the new service.
6.  **Add necessary imports:** Ensure all required types and services are imported.
# Task: Enhance MetadataQueryService

**Source Prompt Reference:** This task is defined by the prompt: `/home/ubuntu/biomapper/roadmap/_active_prompts/2025-06-22-171745-prompt-enhance-metadata-query-service.md`

## 1. Task Objective
Enhance the existing `MetadataQueryService` at `/home/ubuntu/biomapper/biomapper/core/services/metadata_query_service.py` by moving the remaining metadata and database query methods from `MappingExecutor` into it. This centralizes all direct database query logic for metadata.

## 2. Prerequisites
- [x] Required files exist: `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py` and `/home/ubuntu/biomapper/biomapper/core/services/metadata_query_service.py`.
- [x] Required permissions: Write access to `/home/ubuntu/biomapper/biomapper/core/services/`.

## 3. Task Decomposition
1.  **Open `metadata_query_service.py`:** Open the existing service file for editing.
2.  **Move `_get_endpoint_by_name`:** Move this method from `MappingExecutor` to `MetadataQueryService`. Rename it to `get_endpoint_by_name` (making it public).
3.  **Move `get_strategy`:** Move this method from `MappingExecutor` to `MetadataQueryService`.
4.  **Update `__init__`:** Ensure the `MetadataQueryService` is initialized with a `SessionManager` or an `async_session` factory to perform its queries.
5.  **Add necessary imports:** Add any missing model or SQLAlchemy imports.
# Task: Create InitializationService to Encapsulate Component Setup

**Source Prompt Reference:** This task is defined by the prompt: `/home/ubuntu/biomapper/roadmap/_active_prompts/2025-06-22-171741-prompt-create-initialization-service.md`

## 1. Task Objective
Create a new, self-contained `InitializationService` in a new file at `/home/ubuntu/biomapper/biomapper/core/engine_components/initialization_service.py`. This service will be responsible for all the logic currently found in `MappingExecutor.__init__`, effectively separating the complex setup of services and components from the `MappingExecutor` facade itself.

## 2. Prerequisites
- [x] Required files exist: `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`
- [x] Required permissions: Write access to `/home/ubuntu/biomapper/biomapper/core/engine_components/`

## 3. Task Decomposition
1.  **Create the new file:** Create `/home/ubuntu/biomapper/biomapper/core/engine_components/initialization_service.py`.
2.  **Define `InitializationService` class:** Inside the new file, create a class named `InitializationService`.
3.  **Create an `initialize_components` method:** This method will take the same configuration parameters as the current `MappingExecutor.__init__` (e.g., `metamapper_db_url`, `mapping_cache_db_url`, `echo_sql`, etc.).
4.  **Move initialization logic:** Transfer the entire logic from `MappingExecutor.__init__` into the `initialize_components` method. This includes:
    *   Distinguishing between legacy (config-based) and component-based initialization.
    *   Instantiating all services (`SessionManager`, `ClientManager`, `StrategyOrchestrator`, etc.).
    *   The existing `MappingExecutorInitializer` class can be refactored or its logic directly absorbed into this new service.
5.  **Return a components dictionary:** The `initialize_components` method should return a dictionary containing all the initialized service instances (e.g., `{'session_manager': sm_instance, 'client_manager': cm_instance, ...}`).
6.  **Add necessary imports:** Copy all necessary imports from `mapping_executor.py` to the new file.

## 4. Implementation Requirements
- **Input file:** `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`
- **Expected output:** A new file `/home/ubuntu/biomapper/biomapper/core/engine_components/lifecycle_manager.py`.
- **Code standards:** Follow existing project conventions.
- **Input file:** `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`
- **Expected output:** A new file `/home/ubuntu/biomapper/biomapper/core/engine_components/mapping_coordinator_service.py`.
- **Code standards:** Follow existing project conventions.

## 5. Error Recovery Instructions
- **Dependency Errors:** Ensure the service's `__init__` correctly accepts its dependencies.

## 6. Success Criteria and Validation
Task is complete when:
- [ ] The file `/home/ubuntu/biomapper/biomapper/core/engine_components/mapping_coordinator_service.py` exists.
- [ ] The `MappingCoordinatorService` class contains the `execute_mapping` and `execute_path` methods.
- [ ] The logic is identical to the original methods in `MappingExecutor`.

## 5. Error Recovery Instructions
- **Refactoring:** The existing `ExecutionLifecycleService` already handles some of this. You can choose to either enhance the existing service or have the new `LifecycleManager` delegate to it. The goal is to remove this logic from the `MappingExecutor` facade.

## 6. Success Criteria and Validation
Task is complete when:
- [ ] The file `/home/ubuntu/biomapper/biomapper/core/engine_components/lifecycle_manager.py` exists.
- [ ] The `LifecycleManager` class contains all the specified lifecycle-related methods.
- [ ] The logic is identical to the original methods in `MappingExecutor`.

## 7. Feedback Requirements
Create a detailed Markdown feedback file at:
`[PROJECT_ROOT]/roadmap/_active_prompts/feedback/YYYY-MM-DD-HHMMSS-feedback-create-lifecycle-manager.md`
## 7. Feedback Requirements
Create a detailed Markdown feedback file at:
`[PROJECT_ROOT]/roadmap/_active_prompts/feedback/YYYY-MM-DD-HHMMSS-feedback-create-mapping-coordinator-service.md`
- **Input file:** `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`
- **Expected output:** A new file `/home/ubuntu/biomapper/biomapper/core/engine_components/strategy_coordinator_service.py`.
- **Code standards:** Follow existing project conventions.

## 5. Error Recovery Instructions
- **Dependency Errors:** The new service will depend on other services. Ensure its `__init__` method accepts these services as arguments.
- **Circular Dependencies:** Be mindful of potential circular dependencies. This service should call other services, not the other way around.
- **Input files:** `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`, `/home/ubuntu/biomapper/biomapper/core/services/metadata_query_service.py`
- **Expected output:** An updated `/home/ubuntu/biomapper/biomapper/core/services/metadata_query_service.py` file.
- **Code standards:** Follow existing project conventions.

## 5. Error Recovery Instructions
- **Method Signature:** The methods in `MetadataQueryService` should not have a `self` from `MappingExecutor`. They will rely on the `SessionManager` provided during their own initialization.
- **Input file:** `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`
- **Expected output:** A new file `/home/ubuntu/biomapper/biomapper/core/engine_components/initialization_service.py` containing the `InitializationService` class.
- **Code standards:** Follow existing project conventions for styling, typing, and documentation.

## 5. Error Recovery Instructions
- **Import Errors:** If you encounter import errors, ensure all required modules from `mapping_executor.py` are correctly imported in the new file. Add `__init__.py` files to directories if they are missing.
- **Logic/Implementation Errors:** The goal is to lift and shift the logic. Do not refactor the logic itself in this step, only move it. This will minimize the risk of new bugs.

## 6. Success Criteria and Validation
Task is complete when:
- [ ] The file `/home/ubuntu/biomapper/biomapper/core/engine_components/strategy_coordinator_service.py` exists.
- [ ] The `StrategyCoordinatorService` class contains methods for executing all three types of strategies.
- [ ] The logic within these methods is identical to the logic in the original `MappingExecutor` methods.

## 7. Feedback Requirements
Create a detailed Markdown feedback file at:
`[PROJECT_ROOT]/roadmap/_active_prompts/feedback/YYYY-MM-DD-HHMMSS-feedback-create-strategy-coordinator-service.md`
## 6. Success Criteria and Validation
Task is complete when:
- [ ] The file `/home/ubuntu/biomapper/biomapper/core/engine_components/initialization_service.py` exists.
- [ ] The file contains a class `InitializationService` with an `initialize_components` method.
- [ ] The `initialize_components` method contains the logic from `MappingExecutor.__init__` and returns a dictionary of initialized components.
- [ ] The new file is free of syntax errors.

## 6. Success Criteria and Validation
Task is complete when:
- [ ] The `MetadataQueryService` class now contains the `get_endpoint_by_name` and `get_strategy` methods.
- [ ] The logic is identical to the original methods, adapted for the service's own dependencies.

## 7. Feedback Requirements
Create a detailed Markdown feedback file at:
`[PROJECT_ROOT]/roadmap/_active_prompts/feedback/YYYY-MM-DD-HHMMSS-feedback-enhance-metadata-query-service.md`
## 7. Feedback Requirements
Create a detailed Markdown feedback file at:
`[PROJECT_ROOT]/roadmap/_active_prompts/feedback/YYYY-MM-DD-HHMMSS-feedback-create-initialization-service.md`

**Mandatory Feedback Sections:**
- **Execution Status:** [COMPLETE_SUCCESS | PARTIAL_SUCCESS | FAILED_WITH_RECOVERY_OPTIONS | FAILED_NEEDS_ESCALATION]
- **Completed Subtasks:** [checklist of what was accomplished]
- **Issues Encountered:** [detailed error descriptions with context]
- **Next Action Recommendation:** [specific follow-up needed]
