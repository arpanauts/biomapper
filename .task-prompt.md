# Task: Refactor MappingExecutor into a Pure Facade

**Task Objective:**
Refactor the `MappingExecutor` class to be a pure facade. Its `__init__` method should be drastically simplified to only accept pre-constructed, high-level components (coordinators and managers) from the `MappingExecutorBuilder`. All internal component creation logic must be removed.

**Prerequisites:**
- The `MappingExecutorBuilder` has been created and can assemble all necessary components (as per `prompt-2-create-builder.md`).

**Input Context:**
- `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`: The primary file to be modified.
- `/home/ubuntu/biomapper/biomapper/core/engine_components/mapping_executor_builder.py`: The builder that will now be responsible for constructing the executor.

**Expected Outputs:**
1.  A modified `mapping_executor.py` where `MappingExecutor.__init__` is simplified.
    - The new `__init__` will accept `strategy_coordinator`, `mapping_coordinator`, `lifecycle_manager`, and any other directly required services as arguments.
    - It will *not* instantiate any classes itself. It will only assign the provided arguments to `self`.
2.  The `MappingExecutor.create` class method will be updated to use the `MappingExecutorBuilder` to construct and return the executor instance.
# Task: Create MappingExecutorBuilder

**Task Objective:**
Create a new `MappingExecutorBuilder` class in a new file. This builder will be responsible for constructing a fully-configured `MappingExecutor` instance. It will use the `InitializationService` to create low-level components and will then be responsible for instantiating and wiring together the high-level coordinator and manager services.

**Prerequisites:**
- The `InitializationService` has been refactored to be the single source for creating low-level components (as per `prompt-1-refactor-initializer.md`).

**Input Context:**
- `/home/ubuntu/biomapper/biomapper/core/engine_components/initialization_service.py`: To be used by the builder.
- `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`: The class that the builder will construct.

**Expected Outputs:**
1.  A new file: `/home/ubuntu/biomapper/biomapper/core/engine_components/mapping_executor_builder.py`.
2.  This file will contain the `MappingExecutorBuilder` class.
3.  The builder will have a `build()` method that:
    a. Takes configuration parameters in its `__init__`.
    b. Uses `InitializationService` to get base components.
    c. Instantiates `StrategyCoordinatorService`, `MappingCoordinatorService`, and `LifecycleManager`, providing them with their dependencies from the component dictionary.
    d. Returns a fully assembled `MappingExecutor` instance.
# Task: Solidify Coordinator Delegation in MappingExecutor

**Task Objective:**
Ensure that all public operational methods in `MappingExecutor` (e.g., `execute_mapping`, `execute_strategy`, `_execute_path`) are purely delegating calls to the appropriate coordinator service (`MappingCoordinatorService` or `StrategyCoordinatorService`). No business logic should remain in the `MappingExecutor` methods themselves.

**Prerequisites:**
- The `MappingExecutor` has been refactored to receive its coordinators via its `__init__` method (as per `prompt-3-refactor-executor-facade.md`).
- The `MappingCoordinatorService` and `StrategyCoordinatorService` exist.

**Input Context:**
- `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`: The file to be modified.
- `/home/ubuntu/biomapper/biomapper/core/engine_components/mapping_coordinator_service.py`: A target for delegation.
- `/home/ubuntu/biomapper/biomapper/core/engine_components/strategy_coordinator_service.py`: A target for delegation.

**Expected Outputs:**
1.  A modified `mapping_executor.py` file where the implementations of `execute_mapping`, `execute_strategy`, and `_execute_path` consist of a single line: a call to the corresponding method on the appropriate coordinator.
2.  Any logic, parameter transformation, or default value handling that currently exists in the `MappingExecutor` methods will be moved into the respective coordinator service method.

**Success Criteria:**
- `MappingExecutor.__init__` contains no logic other than assigning arguments to instance attributes.
- `MappingExecutor` is no longer responsible for creating its own dependencies.
- The `MappingExecutor.create` method successfully uses the `MappingExecutorBuilder`.
- All existing tests for `MappingExecutor` are refactored to use the builder for setup and they all pass.

**Error Recovery Instructions:**
- If a method in `MappingExecutor` requires a low-level component that is no longer available, refactor it to call a method on one of its high-level coordinators instead.
- If tests are difficult to refactor, it may indicate that the `MappingExecutor` is still doing too much work. Re-evaluate its methods for further delegation.
- The `MappingExecutorBuilder` can successfully build a `MappingExecutor` instance that is fully functional.
- The builder correctly wires all dependencies between services and coordinators.
- The creation of the `MappingExecutor` is now entirely handled by the builder, separating construction from operation.

**Error Recovery Instructions:**
- If dependency injection becomes complex, clearly document the dependency graph in the code comments.
- If the builder cannot resolve a dependency, ensure the `InitializationService` is providing it correctly.
- The `MappingExecutor` methods are simple, one-line delegations.
- The facade pattern is strictly enforced.
- All logic resides within the service layer (the coordinators), not the facade.
- The application's behavior remains unchanged, and all tests pass.

**Error Recovery Instructions:**
- If moving logic to a coordinator requires that coordinator to have a new dependency, update the `MappingExecutorBuilder` to inject that dependency correctly.
- If a method seems to not fit in any existing coordinator, consider if a new coordinator service is needed. Document this for future work.

**Environment Requirements:**
- Access to the `biomapper` codebase.
- `poetry` environment fully installed and operational.
**Environment Requirements:**
- Access to the `biomapper` codebase.
- `poetry` environment fully installed and operational.
**Environment Requirements:**
- Access to the `biomapper` codebase.
- `poetry` environment fully installed and operational.

**Task Decomposition:**
1.  Modify the signature of `MappingExecutor.__init__` to accept the high-level coordinator and manager services.
2.  Remove all component instantiation logic from `__init__`.
3.  Update the `MappingExecutor.create` class method to instantiate `MappingExecutorBuilder` and call its `build()` method.
4.  Go through every method in `MappingExecutor` and ensure it can still access its dependencies through the new high-level components.
5.  Refactor the unit tests for `MappingExecutor`. The setup for these tests will now involve using the `MappingExecutorBuilder` to create the object under test.
6.  Run the refactored tests to ensure they all pass.

**Validation Checkpoints:**
- After refactoring `__init__`, confirm that no services are being created within the method.
- After updating `create`, test it manually or via a unit test to ensure it returns a valid executor.
- After refactoring the tests, run the entire test suite.

**Source Prompt Reference:**
- `/home/ubuntu/biomapper/roadmap/_active_prompts/2025-06-22-204511-prompt-3-refactor-executor-facade.md`

**Context from Previous Attempts:**
- This is the first attempt at this specific refactoring.
1.  Create the new file `mapping_executor_builder.py`.
2.  Define the `MappingExecutorBuilder` class with an `__init__` that accepts configuration.
3.  Implement the `build` method.
4.  Inside `build`, first call `InitializationService` to get the dictionary of base components.
5.  Instantiate the high-level coordinators (`StrategyCoordinatorService`, `MappingCoordinatorService`) and `LifecycleManager`, passing the required components to their constructors.
6.  Instantiate the `MappingExecutor` (note: its `__init__` will be simplified in a parallel task), passing the fully-wired coordinators and managers.
7.  Return the `MappingExecutor` instance.
8.  Create a new unit test file `tests/core/engine_components/test_mapping_executor_builder.py` to verify the builder works as expected.

**Validation Checkpoints:**
- After implementing the `build` method, write a unit test to confirm it returns a `MappingExecutor` instance without errors.
- The unit test should assert that the executor's coordinator attributes are correctly assigned.

**Source Prompt Reference:**
- `/home/ubuntu/biomapper/roadmap/_active_prompts/2025-06-22-204511-prompt-2-create-builder.md`

**Context from Previous Attempts:**
- This is the first attempt to create the builder class.
1.  Review the implementation of `execute_mapping` in `MappingExecutor`. Move any logic into `MappingCoordinatorService.execute_mapping`. Ensure the executor method is a simple `return self.mapping_coordinator.execute_mapping(...)`.
2.  Review the implementation of `execute_strategy` in `MappingExecutor`. Move any logic into `StrategyCoordinatorService.execute_strategy`. Ensure the executor method is a simple `return self.strategy_coordinator.execute_strategy(...)`.
3.  Review the implementation of `_execute_path` in `MappingExecutor`. Move any logic into `MappingCoordinatorService.execute_path`. Ensure the executor method is a simple `return self.mapping_coordinator.execute_path(...)`.
4.  Update the unit tests for `MappingExecutor` to use mocks for the coordinators. The tests should now verify that the correct coordinator method is called with the correct parameters, rather than testing the logic itself.
5.  Run all tests.

**Validation Checkpoints:**
- After refactoring each method, run the relevant tests.
- A code review should confirm that the `MappingExecutor` methods are one-line delegations.

**Source Prompt Reference:**
- `/home/ubuntu/biomapper/roadmap/_active_prompts/2025-06-22-204511-prompt-5-solidify-coordinator-delegation.md`

**Context from Previous Attempts:**
- This is the first attempt at this specific refactoring.
