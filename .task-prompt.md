# Task: Refactor `MappingExecutor` by Extracting Handler Methods into a `MappingHandlerService`
# Task: Systematically Review and Update Project Documentation
# Task: Fix Failing Service-Level Unit Tests

## 1. Objective

Continue the deep refactoring of the oversized `MappingExecutor` class by extracting its large, private `_handle_*` methods into a new, dedicated `MappingHandlerService`. The primary goal is to achieve a significant reduction in `MappingExecutor`'s line count (targeting a ~400-line reduction) and move it closer to being a pure facade that delegates all complex logic to specialized services.
Perform a comprehensive review and update of the project's ReadTheDocs documentation to align it with the recent, significant shift to a service-oriented architecture. The goal is to ensure all documentation is accurate, reflects the current codebase, and provides clear guidance on the new architectural patterns, usage, and configuration.
Resolve the test failures in `tests/unit/core/services/test_metadata_query_service.py`. These tests were created during a previous refactoring but are failing due to incorrect assumptions about the underlying service's API, specifically regarding SQLAlchemy's `scalar()` vs. `scalar_one_or_none()` return behavior.

## 2. Context and Background

The previous refactoring effort successfully extracted the main `execute_*` methods into separate services (`IterativeExecutionService`, `DbStrategyExecutionService`, `YamlStrategyExecutionService`). However, this only resulted in a 12% size reduction, falling short of the 50% target. Feedback analysis revealed that the bulk of the remaining logic resides in three large handler methods used by the YAML strategy executor:

-   `_handle_convert_identifiers_local` (~130 lines)
-   `_handle_execute_mapping_path` (~126 lines)
-   `_handle_filter_identifiers_by_target_presence` (~124 lines)

This task will address this by moving these methods into their own service, which will drastically simplify `MappingExecutor` and improve code modularity.

The Biomapper project has undergone a major refactoring. The previously monolithic `MappingExecutor` has been decomposed into a lean facade that delegates all complex operations to a suite of new, specialized services. Key architectural changes include:

-   **New Services:** `IterativeExecutionService`, `DbStrategyExecutionService`, `YamlStrategyExecutionService`, `MappingHandlerService`, `DirectMappingService`, `PathFinder`, `ClientManager`, and more.
-   **New Patterns:** Heavy reliance on dependency injection and a service-oriented approach.
-   **YAML Strategies:** YAML-defined strategies using `StrategyAction` classes are now the primary method for orchestrating complex mapping pipelines.

The existing documentation, located in `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/docs/source`, is now severely outdated and does not reflect this new architecture. This task is to bring it up to date.
During the refactoring of the core `MappingExecutor` tests, several new test suites were created for the new service classes. The feedback file `2025-06-22-000233-feedback-refactor-core-executor-tests.md` identified that the tests for `MetadataQueryService` are unreliable because the mocks do not accurately reflect the behavior of the SQLAlchemy session they are simulating. This task is a high-priority fix to stabilize this new test suite.

## 3. Task Breakdown

This is a systematic review. Please examine and update the following files and sections within the `docs/source/` directory:

1.  **`index.rst` - The Homepage**:
    -   Review the project's mission statement and high-level overview. Ensure it accurately describes the project's current capabilities and design philosophy (e.g., modular, extensible, configuration-driven).

2.  **`architecture.rst` - Architectural Overview (High Priority)**:
    -   This section requires a complete rewrite.
    -   **Remove** all descriptions of the old, monolithic `MappingExecutor`.
    -   **Add** a new section describing the **Service-Oriented Architecture**.
    -   Create a diagram (using `sphinx.ext.graphviz` or `mermaid` if available, otherwise a clear text description) illustrating how `MappingExecutor` acts as a facade and delegates to the various execution and handler services.
    -   Describe the roles of the key new services (`IterativeExecutionService`, `YamlStrategyExecutionService`, `MappingHandlerService`, etc.).

3.  **`usage.rst` - Usage Guide and Examples (High Priority)**:
    -   Review all code examples.
    -   **Replace** old examples that instantiate and call a monolithic `MappingExecutor`.
    -   **Add** new examples that demonstrate the current, correct usage:
        -   A simple example showing how to instantiate the `MappingExecutor` and call one of its high-level methods (e.g., `execute_mapping`).
        -   A more advanced example showing how to execute a YAML-defined strategy using `execute_yaml_strategy`, including how to pass `initial_context`.

4.  **`configuration.rst` - Configuration Guide**:
    -   Update the documentation for `protein_config.yaml` to reflect any changes in its structure.
    -   **Add a new, detailed section** on `mapping_strategies_config.yaml`.
    -   Explain the structure of a YAML strategy, including the `steps` list and the purpose of `action`, `name`, and `parameters`.
    -   Provide an example of a simple strategy definition.

5.  **API Reference (`api/` directory)**:
    -   The API reference is likely generated by `autodoc` from docstrings. The primary task here is to ensure the source docstrings are accurate.
    -   **Review and update the docstrings** for `MappingExecutor`. They should clearly state that it is a facade and its methods delegate to other services.
    -   **Review the docstrings for all new services** in `biomapper/core/services/`. Ensure they are clear, accurate, and describe the service's responsibility, parameters, and return values.
    -   Ensure the `.rst` files in the `api/` directory are configured to find and document all the new service modules.
## 3. Prerequisites

- The agent must be familiar with the ongoing service-oriented refactoring of the Biomapper project.
- The primary file to be modified is `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/core/mapping_executor.py`.
- The agent must understand how to use `unittest.mock` to create mock objects for SQLAlchemy sessions.
- Familiarity with the difference between `session.execute(...).scalar()` and `session.execute(...).scalar_one_or_none()` is crucial.

## 4. Task Breakdown

1.  **Create `MappingHandlerService`**:
    - In the `biomapper/core/services/` directory, create a new file named `mapping_handler_service.py`.
    - Inside this file, define a new class `MappingHandlerService`.
    - The constructor (`__init__`) for this service must accept all necessary dependencies. Based on the logic within the handler methods, these will likely include:
        - `logger`
        - `client_manager`
        - `path_finder`
        - `async_metamapper_session`
        - `metadata_query_service`
        - `placeholder_resolver`

2.  **Migrate Handler Method Logic**:
    - Locate the methods `_handle_convert_identifiers_local`, `_handle_execute_mapping_path`, and `_handle_filter_identifiers_by_target_presence` in `mapping_executor.py`.
    - **Cut** the entire method bodies from `mapping_executor.py` and **paste** them into the new `MappingHandlerService` class.
    - Rename the methods to be public (e.g., `_handle_convert_identifiers_local` becomes `handle_convert_identifiers_local`).
    - Refactor the method bodies to use the dependencies injected into the service's `__init__` (e.g., `self.client_manager`) instead of assuming they exist on the `MappingExecutor` instance.
    - Adjust the method signatures to accept any parameters that were previously accessed via `self` in `MappingExecutor` but are not part of the service's dependencies. The `execution_context` dictionary is a critical parameter that will need to be passed into these methods.

3.  **Refactor `MappingExecutor`**:
    - In `MappingExecutor.__init__`, instantiate the new `MappingHandlerService`, injecting all its required dependencies.
        ```python
        self.mapping_handler_service = MappingHandlerService(
            logger=self.logger,
            client_manager=self.client_manager,
            # ... other dependencies
        )
        ```
    - Replace the original `_handle_*` method bodies in `MappingExecutor` with a single line that delegates the call to the new service. For example:
        ```python
        async def _handle_execute_mapping_path(self, step: Dict[str, Any], execution_context: Dict[str, Any]) -> Dict[str, Any]:
            return await self.mapping_handler_service.handle_execute_mapping_path(
                step=step, execution_context=execution_context
            )
        ```

4.  **Update `__init__.py`**:
    - Add `MappingHandlerService` to the `__all__` list in `biomapper/core/services/__init__.py` to ensure it is correctly exported.

5.  **Fix Failing Tests**:
    - The previous feedback noted test failures due to a missing `_find_direct_paths` method. This is a pre-existing issue that must be resolved.
    - Investigate the test suite (e.g., `tests/unit/core/test_mapping_executor.py`) to identify which tests are failing.
    - Determine the correct replacement for the `_find_direct_paths` call. The logic may now reside in `PathFinder` or `DirectMappingService`. Update the test to use the correct service and method.

## 5. Implementation Requirements

- **Code Standards:** All new and modified code must be fully type-hinted and follow async/await patterns. Maintain the existing code style.
- **Dependencies:** Ensure all dependencies are correctly injected. Pay close attention to avoiding circular imports, which have been an issue in past refactorings.

## 6. Error Recovery Instructions

- **`AttributeError`:** If the new service methods fail because they are trying to access an attribute that wasn't passed in (e.g., `self.path_finder`), update the `MappingHandlerService` constructor and the instantiation in `MappingExecutor` to pass the required dependency.
- **Circular Imports:** If you encounter `ImportError: cannot import name ...`, use local, in-method imports as a last resort. The ideal solution is to refactor dependencies to break the cycle.
1.  **Navigate to the Target File:**
    - Open `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/tests/unit/core/services/test_metadata_query_service.py`.

2.  **Analyze Failing Tests:**
    - Run `poetry run pytest tests/unit/core/services/test_metadata_query_service.py` to see the current failures.
    - Examine the test failures and identify the exact lines where mock setups or assertions are incorrect.

3.  **Correct Mock Implementations:**
    - Locate the mock setup for the `AsyncSession`.
    - For tests where the service is expected to call `scalar_one_or_none()`, ensure the mock is configured to return a value from that method call.
    - For tests where `scalar()` is used, ensure the mock reflects that. The feedback suggests the service uses `scalar_one_or_none()`, so you will likely need to adjust the mocks to match this.
    - **Example:** If the mock setup is `mock_session.execute.return_value.scalar.return_value = ...`, it may need to be changed to `mock_session.execute.return_value.scalar_one_or_none.return_value = ...`.

4.  **Verify All Tests Pass:**
    - Rerun the pytest command and ensure all tests in the file now pass.

## 4. Implementation Requirements

-   **Format:** All documentation is written in reStructuredText (`.rst`). Adhere to its syntax and conventions.
-   **Clarity:** Write for a developer audience. Be clear, concise, and provide practical examples.
-   **Code Blocks:** Use `.. code-block:: python` for all Python examples.

## 5. Validation and Success Criteria

-   **Primary Validation:** The updated documentation must build successfully without errors or warnings.
-   **Execution Command:** From the `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/docs/` directory, run:
    ```bash
    make html
    ```
-   **Review:** After a successful build, manually open the generated HTML files in `build/html/index.html` and review the changes in a browser to ensure they are rendered correctly and the content is accurate and easy to understand.

## 6. Feedback and Reporting
- **Target File:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/tests/unit/core/services/test_metadata_query_service.py`
- **Code Standards:** Maintain existing test structure and style. Use `unittest.mock` for all mocking.

## 7. Validation and Success Criteria

- **Primary Validation:** The refactoring is successful when the entire test suite passes without errors.
- **Execution Command:** Run `poetry run pytest` from the project root (`/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/`).
- **Code Metrics:** The `mapping_executor.py` file should be reduced in size by approximately 400 lines.
- **New Artifacts:** The new `mapping_handler_service.py` file should be created and contain the extracted logic.

## 8. Feedback and Reporting
- **Primary Success Criterion:** All tests in `test_metadata_query_service.py` pass successfully.
- **Validation Command:** `poetry run pytest tests/unit/core/services/test_metadata_query_service.py`

## 7. Feedback and Reporting

- Provide the `diff` of the changes made to `mapping_executor.py`.
- Provide the full content of the new `mapping_handler_service.py` file.
- Provide the `diff` for any test files you modified.
- Confirm that you ran the validation command and that all tests passed successfully.
-   Provide a summary of the key changes made to each documentation file (`index.rst`, `architecture.rst`, etc.).
-   Confirm that the documentation build was successful (`make html` ran without errors).
-   Confirm that you have manually reviewed the generated HTML and that it looks correct.
- Provide the `diff` of the changes made to the test file.
- Provide the output of the final, successful `pytest` run for the file.
