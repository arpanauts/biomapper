# Task: Fix Failing Integration Tests Due to Configuration Issues
# Task: Implement Unit Tests for the CacheManager Service

## 1. Objective

Resolve the 20 failing integration tests by fixing the underlying test data and configuration problems. The tests have already been updated to be compatible with the new service-oriented API, but they are failing because of issues in the test environment itself.
Create a new, comprehensive suite of unit tests for the `CacheManager` service. The original cache-related tests were part of the monolithic `MappingExecutor` tests and were removed during refactoring, with the intention of creating a dedicated test suite for the new service.

## 2. Context and Background

The feedback from the integration test refactoring (`2025-06-22-000236-feedback-refactor-integration-tests.md`) clearly states that while API compatibility is fixed, numerous tests are still failing. The root cause is identified as missing test data files, incorrect YAML strategy configurations, or other environment-related setup problems. This is the highest priority task to stabilize the test suite, as it will validate the end-to-end functionality of the refactored application.
The `CacheManager` service is responsible for handling the caching of mapping results to avoid redundant computations. During the core executor test refactoring (see feedback `2025-06-22-000233-feedback-refactor-core-executor-tests.md`), the tests for this functionality were deferred. A placeholder file may exist at `tests/unit/core/engine_components/test_cache_manager.py`. This task is to implement the deferred tests and ensure the `CacheManager` is robust and reliable.

## 3. Prerequisites

- The agent must be able to analyze `pytest` error logs to identify the root cause of test failures (e.g., `FileNotFoundError`, `KeyError` from config, assertion errors from unexpected data).
- Familiarity with the project's test data structure in `tests/integration/data/` and the YAML configurations is required.
- The agent must understand the public API and purpose of the `CacheManager` service.
- Proficiency in testing stateful services and using `unittest.mock` is required.

## 4. Task Breakdown

1.  **Run the Integration Test Suite:**
    - Execute `poetry run pytest tests/integration/` to get a baseline of the current failures.

2.  **Systematically Debug Failures:**
    - For each failing test, examine the error message.
    - **If `FileNotFoundError`:** The test is likely missing a required mock data file. Create or locate the necessary file in `tests/integration/data/`.
    - **If `KeyError` or `ValidationError`:** The issue is likely in a `mapping_strategies_config.yaml` or `protein_config.yaml` file used by the test. Verify that all keys, endpoints, and paths are correctly defined.
    - **If `AssertionError`:** The test is running but producing unexpected results. This could still be a data issue. Inspect the input data and the results to see where the discrepancy lies.

3.  **Fix Configurations and Data:**
    - Make the necessary corrections to the data files and YAML configurations.
    - Do **not** change the application code. The goal is to fix the test environment, not the code under test.

4.  **Iterate and Validate:**
    - Rerun the tests after each fix to ensure it was successful and did not introduce new regressions.
    - Continue until all integration tests are passing.
1.  **Locate or Create the Test File:**
    - Find the test file at `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/tests/unit/core/engine_components/test_cache_manager.py`. If it doesn't exist, create it.

2.  **Review the `CacheManager` Implementation:**
    - Open `biomapper/core/engine_components/cache_manager.py` to understand its public methods (e.g., `check_cache`, `cache_results`) and dependencies.

3.  **Implement Unit Tests:**
    - Create a `setup` method or fixture to initialize a `CacheManager` instance for each test.
    - **Test `check_cache`:**
        - Write a test to verify that `check_cache` returns `None` for an identifier that is not in the cache.
        - Write a test to verify that `check_cache` correctly returns the cached data for an identifier that has been previously cached.
    - **Test `cache_results`:**
        - Write a test to verify that after calling `cache_results`, the corresponding data can be retrieved by `check_cache`.
    - **Test Cache Structure:**
        - Write a test to ensure the data is cached in the expected format.
    - **Test Edge Cases:**
        - Test caching and retrieving empty results (`[]`).
        - Test caching and retrieving `None` values if that is a valid use case.

## 5. Implementation Requirements

- **Target Directories:** 
    - `tests/integration/`
    - `tests/integration/data/`
    - Any YAML configuration files used by the integration tests.
- **Code Standards:** Maintain existing file structures and formats.

- **Target File:** `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/tests/unit/core/engine_components/test_cache_manager.py`
- **Code Standards:** All tests must be `async def` and use `pytest` and `unittest.mock`. Follow existing project conventions.

## 6. Validation and Success Criteria

- **Primary Success Criterion:** All tests in the `tests/integration/` directory pass successfully.
- **Validation Command:** `poetry run pytest tests/integration/`
- **Success:** A new test suite for `CacheManager` is created, and all tests within it pass.
- **Validation Command:** `poetry run pytest tests/unit/core/engine_components/test_cache_manager.py`

## 7. Feedback and Reporting

- Provide a summary of the types of configuration issues you fixed (e.g., "Fixed 5 missing data files," "Corrected 3 endpoint names in strategy configs").
- Provide the final output of the `pytest tests/integration/` run showing that all tests pass.
- Provide the full content of the new `test_cache_manager.py` file.
- Provide the output of the `pytest` run to confirm all tests pass.
