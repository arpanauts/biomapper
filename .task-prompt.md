# Task: Decompose LifecycleManager

**Task Objective:**
Analyze and refactor the `biomapper.core.engine_components.lifecycle_manager.LifecycleManager`. This class currently has broad responsibilities, including session management, checkpointing, and client connections. Decompose it into smaller, more focused services to improve modularity and adhere to the Single Responsibility Principle.

**Prerequisites:**
- The `LifecycleManager` class exists at `/home/ubuntu/biomapper/biomapper/core/engine_components/lifecycle_manager.py`.

**Input Context:**
- `/home/ubuntu/biomapper/biomapper/core/engine_components/lifecycle_manager.py`: The primary file to be analyzed and refactored.
- `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`: To understand how the `LifecycleManager` is currently used.

**Expected Outputs:**
1.  New service class files created within `/home/ubuntu/biomapper/biomapper/core/services/`, for example:
    - `execution_session_service.py`: Manages the lifecycle of a mapping session (creation, status updates).
    - `checkpoint_service.py`: Handles saving and loading of checkpoints.
2.  The existing `LifecycleManager` will be either removed or become a higher-level coordinator that delegates to the new, smaller services.
3.  A new unit test file for each new service class created.
# Task: Integrate DatabaseSetupService into the Builder

**Task Objective:**
Integrate the database table initialization logic, currently handled by `DatabaseSetupService` as a separate step in `MappingExecutor.create`, into the main `MappingExecutorBuilder` workflow. The goal is that a successfully built executor is guaranteed to have its required database tables initialized.

**Prerequisites:**
- The `MappingExecutorBuilder` has been created (as per `prompt-2-create-builder.md`).
- The `DatabaseSetupService` exists at `/home/ubuntu/biomapper/biomapper/core/services/database_setup_service.py`.

**Input Context:**
- `/home/ubuntu/biomapper/biomapper/core/engine_components/mapping_executor_builder.py`: The builder to be modified.
- `/home/ubuntu/biomapper/biomapper/core/services/database_setup_service.py`: The service whose logic needs to be integrated.
- `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`: The `create` method here shows the current, separate invocation of the setup service.

**Expected Outputs:**
1.  The `MappingExecutorBuilder`'s `build` method (or a new `async_build` method) will be responsible for invoking the `DatabaseSetupService` to initialize both the metamapper and cache database tables.
2.  The `MappingExecutor.create` method will be simplified, as it will no longer need to call the `DatabaseSetupService` itself.
3.  The `DatabaseSetupService` might be absorbed into the builder or `InitializationService` if its logic is simple enough, or it will be instantiated and used within the builder.

**Success Criteria:**
- The responsibilities of the original `LifecycleManager` are now handled by several smaller, more focused services.
- The new services are easier to understand and test in isolation.
- The overall functionality of session management and checkpointing remains intact.
- All related unit tests are updated and pass.

**Error Recovery Instructions:**
- If a clean separation is not possible, document the reasons in the code. It may be that `LifecycleManager` is a valid coordinator. In this case, rename it to `LifecycleCoordinator` and ensure its methods are pure delegations.
- If refactoring breaks existing tests, address the test failures immediately. Do not leave the test suite in a broken state.
- Creating a `MappingExecutor` via the builder results in an instance that can immediately interact with its databases because the tables have already been created.
- The database setup logic is no longer a separate, manual step in the `create` method.
- All tests related to database interaction and executor creation pass.

**Error Recovery Instructions:**
- If making the `build` method async is problematic, create a separate `async_build` method on the builder and leave the synchronous `build` for testing scenarios that use mock databases.
- If the database service requires the `AsyncEngine`, ensure it's created first within the builder's workflow before the setup service is called.

**Environment Requirements:**
- Access to the `biomapper` codebase.
- `poetry` environment fully installed and operational.
**Environment Requirements:**
- Access to the `biomapper` codebase.
- `poetry` environment fully installed and operational.

**Task Decomposition:**
1.  Read through `LifecycleManager` and categorize its public methods by responsibility (e.g., 'checkpointing', 'session management', 'client shutdown').
2.  For each category, define a new service class (e.g., `CheckpointService`).
3.  Create the new files for these services in `/home/ubuntu/biomapper/biomapper/core/services/`.
4.  Move the relevant methods and attributes from `LifecycleManager` into the new service classes.
5.  Refactor the `LifecycleManager` to delegate calls to these new services, or remove it if it's no longer needed.
6.  Update the `MappingExecutorBuilder` to construct these new services and pass them to the relevant components.
7.  Create unit tests for each new service.
8.  Run the full test suite.

**Validation Checkpoints:**
- After creating each new service, write its unit tests and ensure they pass.
- After refactoring `LifecycleManager`, run the tests that previously covered its functionality to ensure they still pass against the new structure.

**Source Prompt Reference:**
- `/home/ubuntu/biomapper/roadmap/_active_prompts/2025-06-22-204511-prompt-4-decompose-lifecycle-manager.md`

**Context from Previous Attempts:**
- This is the first attempt at decomposing the `LifecycleManager`.
1.  Analyze `MappingExecutor.create` to understand how `DatabaseSetupService` is currently used.
2.  Modify `MappingExecutorBuilder`. Decide whether to add the logic to the existing `build` method (making it async) or create a new `async_build` method.
3.  Inside the chosen build method, instantiate `DatabaseSetupService`.
4.  Call the `initialize_tables` method for both the metamapper and cache databases using the engines created by the `InitializationService`.
5.  Remove the database setup logic from `MappingExecutor.create`, simplifying it to just use the builder.
6.  Review and update unit tests to ensure they account for this change. Tests might need to mock the `DatabaseSetupService` call.
7.  Run the full test suite.

**Validation Checkpoints:**
- After modifying the builder, write a test to ensure that the `initialize_tables` method on `DatabaseSetupService` is called during the build process.
- After simplifying `MappingExecutor.create`, run tests that use it to ensure they still work.

**Source Prompt Reference:**
- `/home/ubuntu/biomapper/roadmap/_active_prompts/2025-06-22-204511-prompt-6-integrate-db-setup.md`

**Context from Previous Attempts:**
- This is the first attempt to integrate the database setup into the builder.
