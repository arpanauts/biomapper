# UKBB Proteins to Kraken Proto-Strategy

This is a **proto-strategy** for mapping UKBB Olink proteomics data to Kraken Knowledge Graph protein nodes using direct UniProt ID matching.

## Overview

Maps ~3,000 UKBB Olink proteins to Kraken 1.0.0 protein ontology through direct UniProt identifier joins. Expected match rate: 90-98%.

## Files

### Core Scripts (run in order)
- `01_load_ukbb_proteins.py` - Load and clean UKBB protein metadata
- `02_load_kraken_proteins.py` - Load and process Kraken protein nodes
- `03_map_proteins.py` - Perform direct ID mapping
- `04_generate_report.py` - Generate comprehensive reports

### Orchestration
- `run_all.sh` - Complete pipeline execution
- `README.md` - This documentation

### Data Directories
- `data/` - Intermediate processed files
- `results/` - Final outputs and reports

## Input Data

### UKBB Source
- **File**: `/procedure/data/local_data/MAPPING_ONTOLOGIES/ukbb/UKBB_Protein_Meta.tsv`
- **Format**: TSV with columns: Assay, UniProt, Panel
- **Size**: ~3,000 Olink proteins

### Kraken Target
- **File**: `/procedure/data/local_data/MAPPING_ONTOLOGIES/kraken_1.0.0_ontologies/uniprot_kraken_nodes_v1.0.0.tsv`
- **Format**: TSV with protein node information
- **ID Handling**: Strips "UniProtKB:" prefix for matching

## Usage

### Quick Start
```bash
# Run complete pipeline
./run_all.sh
```

### Individual Steps
```bash
# Step by step execution
python3 01_load_ukbb_proteins.py
python3 02_load_kraken_proteins.py
python3 03_map_proteins.py
python3 04_generate_report.py
```

## Outputs

### Main Results
- `results/ukbb_kraken_mappings.tsv` - Complete mappings with metadata
- `results/mapping_statistics.json` - Detailed statistics
- `results/MAPPING_REPORT.md` - Human-readable analysis

### Analysis Files
- `results/panel_coverage_report.tsv` - Panel-wise statistics
- `results/unmatched_proteins.tsv` - Unmapped proteins for review
- `results/pipeline_summary.json` - Quick reference metrics

### Required Output Fields

Following the project specifications:
- `ukbb_uniprot`, `ukbb_assay`, `ukbb_panel` - UKBB metadata
- `ukb_field_id`, `olink_id` - Field identifiers (if available)
- `kraken_node_id`, `kraken_name`, `kraken_category` - Kraken metadata
- `mapping_confidence` - 1.0 for matches, 0.0 for unmatched
- `disease_associations` - From protein_disease_edges.tsv (if available)

## Technical Approach

### Direct ID Matching
Following the Complete Mapping Guide principle: "ALL MAPPINGS ARE DIRECT ID MATCHES"

```python
# Core mapping logic
mapped = ukbb_df.merge(
    kraken_df,
    left_on='ukbb_uniprot',          # UKBB UniProt column
    right_on='clean_uniprot_id',     # Kraken cleaned UniProt ID
    how='left'                       # Keep all UKBB proteins
)
```

### ID Processing
- **UKBB**: Clean and normalize UniProt IDs (trim whitespace, uppercase)
- **Kraken**: Strip "UniProtKB:" prefix from node IDs
- **Join**: Direct pandas merge, no fuzzy matching

### Quality Assurance
- Validation against expected match rates (90-98%)
- Panel-wise coverage analysis
- Unmatched protein identification
- Confidence score assignment

## Validation Criteria

✓ Target match rate: 90-98% (Olink uses standard UniProt)
✓ UKBB field IDs preserved (as available in source)
✓ Panel information retained for all proteins
✓ Confidence scores reflect mapping quality
✓ Processing time: 15-20 minutes
✓ Cross-reference capability with Olink documentation

## Expected Performance

- **Processing Time**: 15-20 minutes
- **Memory Usage**: 2-3GB
- **Match Rate**: 90-98% (excellent for Olink platform)
- **Output Size**: ~2,900 mapped proteins

## Dependencies

- Python 3.x
- pandas
- Standard library (json, pathlib, datetime)

No BiOMapper framework dependencies - this is a standalone proto-strategy.

## Notes

- This is a **proto-strategy** using pure Python/pandas operations
- No BiOMapper YAML strategies or framework dependencies
- Follows standardized proto-strategy structure for future conversion
- Direct file I/O using absolute paths from Complete Mapping Guide
- Preserves biobank-specific metadata and panel categories

## Troubleshooting

### Common Issues
1. **FileNotFoundError**: Check input file paths in scripts
2. **Low match rate**: Verify UniProt ID formatting and Kraken file structure
3. **Memory errors**: Ensure 2-3GB available RAM
4. **Permission errors**: Run `chmod +x *.py run_all.sh`

### Support
- Refer to `/home/ubuntu/biomapper/data/COMPLETE_MAPPING_GUIDE.md`
- Review intermediate outputs in `data/` directory
- Check detailed logs in terminal output

---

Generated by UKBB-to-Kraken proto-strategy pipeline