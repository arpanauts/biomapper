# Test configuration for optional steps in YAML strategies

entity_types:
  test_optional:
    description: "Test optional entity type"
    version: "1.0"
    example_identifiers: ["TEST1", "P12345", "HGNC:1234"]

ontologies:
  hgnc:
    name: "HGNC"
    description: "HUGO Gene Nomenclature Committee - Test"
  uniprot:
    name: "UniProt"
    description: "Universal Protein Resource - Test"
  ensembl:
    name: "Ensembl"
    description: "Ensembl genome database - Test"

databases:
  test_uniprot:
    endpoint:
      name: "test_target"
      description: "Test target endpoint"
      type: "file_tsv"
      connection_details:
        file_path: "tests/integration/data/mock_client_files/test_uniprot.tsv"
        delimiter: "\t"
    properties:
      primary: "uniprot"
      mappings:
        uniprot:
          column: "Entry"
          ontology_type: "uniprot"
        hgnc:
          column: "Gene Names"
          ontology_type: "hgnc"
          
  test_hgnc:
    endpoint:
      name: "test_source"
      description: "Test source endpoint"
      type: "file_tsv"
      connection_details:
        file_path: "tests/integration/data/mock_client_files/test_hgnc.tsv"
        delimiter: "\t"
    properties:
      primary: "hgnc"
      mappings:
        hgnc_id:
          column: "hgnc_id"
          ontology_type: "hgnc"
        symbol:
          column: "symbol"
          ontology_type: "hgnc"

# Additional mapping resources  
additional_resources:
  - name: "test_uniprot_mapper"
    client_class_path: "biomapper.mapping.clients.generic_file_client.GenericFileLookupClient"
    input_ontology_type: "hgnc"
    output_ontology_type: "uniprot"
    config:
      file_path: "tests/integration/data/mock_client_files/test_uniprot.tsv"
      key_column: "Gene Names"
      value_column: "Entry"
      delimiter: "\t"
      
  - name: "test_optional_fail_mapper"
    client_class_path: "biomapper.mapping.clients.generic_file_client.GenericFileLookupClient"
    input_ontology_type: "hgnc"
    output_ontology_type: "ensembl"
    config:
      file_path: "tests/integration/data/mock_client_files/non_existent_file.tsv"
      key_column: "gene"
      value_column: "ensembl_id"
      delimiter: "\t"

# Mapping paths for the test entity
mapping_paths:
  - name: "optional_gene_to_uniprot"
    description: "Map gene symbols to UniProt IDs (for optional steps test)"
    source_type: "hgnc"
    target_type: "uniprot"
    priority: 1
    steps:
      - resource: "test_uniprot_mapper"
        order: 1
        
  - name: "optional_gene_to_ensembl_fail"
    description: "Map gene symbols to Ensembl IDs (will fail)"
    source_type: "hgnc"
    target_type: "ensembl"
    priority: 1
    steps:
      - resource: "test_optional_fail_mapper"
        order: 1

# Mapping strategies for test entity
mapping_strategies:
  # Strategy with all optional steps
  all_optional_strategy:
    description: "Strategy where all steps are optional"
    steps:
      - step_id: "S1_OPTIONAL_CONVERT"
        description: "Optional conversion that should succeed"
        is_required: false
        action:
          type: "CONVERT_IDENTIFIERS_LOCAL"
          input_ontology_type: "hgnc"
          output_ontology_type: "uniprot"
          endpoint_context: "TARGET"
          mapping_path_name: "optional_gene_to_uniprot"
      
      - step_id: "S2_OPTIONAL_FAIL"
        description: "Optional conversion that will fail"
        is_required: false
        action:
          type: "CONVERT_IDENTIFIERS_LOCAL"
          input_ontology_type: "hgnc"
          output_ontology_type: "ensembl"
          endpoint_context: "TARGET"
          mapping_path_name: "optional_gene_to_ensembl_fail"
      
      - step_id: "S3_OPTIONAL_FILTER"
        description: "Optional filter step"
        is_required: false
        action:
          type: "FILTER_IDENTIFIERS_BY_TARGET_PRESENCE"
          endpoint_context: "TARGET"
          ontology_type_to_match: "uniprot"
          resource_name_for_check: "test_uniprot_mapper"
          include_if_present: true
  
  # Strategy with mixed required and optional steps
  mixed_required_optional_strategy:
    description: "Strategy with both required and optional steps"
    steps:
      - step_id: "S1_REQUIRED"
        description: "Required step that should succeed"
        is_required: true
        action:
          type: "CONVERT_IDENTIFIERS_LOCAL"
          input_ontology_type: "hgnc"
          output_ontology_type: "uniprot"
          endpoint_context: "TARGET"
          mapping_path_name: "optional_gene_to_uniprot"
      
      - step_id: "S2_OPTIONAL_FAIL"
        description: "Optional step that will fail"
        is_required: false
        action:
          type: "EXECUTE_MAPPING_PATH"
          path_name: "optional_gene_to_ensembl_fail"
          pass_unmapped: true
      
      - step_id: "S3_REQUIRED_FILTER"
        description: "Required filter step after optional failure"
        is_required: true
        action:
          type: "FILTER_IDENTIFIERS_BY_TARGET_PRESENCE"
          endpoint_context: "TARGET"
          ontology_type_to_match: "uniprot"
          resource_name_for_check: "test_uniprot_mapper"
          include_if_present: true
  
  # Strategy with optional step failing first
  optional_fail_first_strategy:
    description: "Strategy where first step is optional and fails"
    steps:
      - step_id: "S1_OPTIONAL_FAIL_FIRST"
        description: "First step is optional and will fail"
        is_required: false
        action:
          type: "CONVERT_IDENTIFIERS_LOCAL"
          input_ontology_type: "hgnc"
          output_ontology_type: "ensembl"
          endpoint_context: "TARGET"
          mapping_path_name: "non_existent_path"
      
      - step_id: "S2_REQUIRED_CONVERT"
        description: "Required step that should succeed"
        is_required: true
        action:
          type: "CONVERT_IDENTIFIERS_LOCAL"
          input_ontology_type: "hgnc"
          output_ontology_type: "uniprot"
          endpoint_context: "TARGET"
          mapping_path_name: "optional_gene_to_uniprot"
  
  # Strategy with optional step failing last
  optional_fail_last_strategy:
    description: "Strategy where last step is optional and fails"
    steps:
      - step_id: "S1_REQUIRED_SUCCESS"
        description: "Required step that succeeds"
        is_required: true
        action:
          type: "CONVERT_IDENTIFIERS_LOCAL"
          input_ontology_type: "hgnc"
          output_ontology_type: "uniprot"
          endpoint_context: "TARGET"
          mapping_path_name: "optional_gene_to_uniprot"
      
      - step_id: "S2_OPTIONAL_FAIL_LAST"
        description: "Last step is optional and will fail"
        is_required: false
        action:
          type: "FILTER_IDENTIFIERS_BY_TARGET_PRESENCE"
          endpoint_context: "TARGET"
          ontology_type_to_match: "uniprot"
          resource_name_for_check: "non_existent_resource"
          include_if_present: true
  
  # Strategy with multiple sequential optional failures
  multiple_optional_failures_strategy:
    description: "Strategy with multiple optional steps failing in sequence"
    steps:
      - step_id: "S1_OPTIONAL_FAIL_1"
        description: "First optional failure"
        is_required: false
        action:
          type: "CONVERT_IDENTIFIERS_LOCAL"
          input_ontology_type: "hgnc"
          output_ontology_type: "ensembl"
          endpoint_context: "TARGET"
          mapping_path_name: "non_existent_path_1"
      
      - step_id: "S2_OPTIONAL_FAIL_2"
        description: "Second optional failure"
        is_required: false
        action:
          type: "EXECUTE_MAPPING_PATH"
          path_name: "non_existent_path"
          pass_unmapped: false
      
      - step_id: "S3_REQUIRED_SUCCESS"
        description: "Required step that should succeed"
        is_required: true
        action:
          type: "CONVERT_IDENTIFIERS_LOCAL"
          input_ontology_type: "hgnc"
          output_ontology_type: "uniprot"
          endpoint_context: "TARGET"
          mapping_path_name: "optional_gene_to_uniprot"
      
      - step_id: "S4_OPTIONAL_FAIL_3"
        description: "Third optional failure"
        is_required: false
        action:
          type: "FILTER_IDENTIFIERS_BY_TARGET_PRESENCE"
          endpoint_context: "TARGET"
          ontology_type_to_match: "uniprot"
          resource_name_for_check: "non_existent_resource_3"
          include_if_present: true
  
  # Strategy where required step fails after optional steps
  required_fail_after_optional_strategy:
    description: "Strategy where required step fails after optional steps"
    steps:
      - step_id: "S1_OPTIONAL_SUCCESS"
        description: "Optional step that succeeds"
        is_required: false
        action:
          type: "CONVERT_IDENTIFIERS_LOCAL"
          input_ontology_type: "hgnc"
          output_ontology_type: "uniprot"
          endpoint_context: "TARGET"
          mapping_path_name: "optional_gene_to_uniprot"
      
      - step_id: "S2_OPTIONAL_FAIL"
        description: "Optional step that fails"
        is_required: false
        action:
          type: "FILTER_IDENTIFIERS_BY_TARGET_PRESENCE"
          endpoint_context: "TARGET"
          ontology_type_to_match: "uniprot"
          resource_name_for_check: "non_existent_resource"
          include_if_present: true
      
      - step_id: "S3_REQUIRED_FAIL"
        description: "Required step that will fail"
        is_required: true
        action:
          type: "CONVERT_IDENTIFIERS_LOCAL"
          input_ontology_type: "hgnc"
          output_ontology_type: "ensembl"
          endpoint_context: "TARGET"
          mapping_path_name: "non_existent_required_path"
  
  # Edge case: All optional steps fail
  all_optional_fail_strategy:
    description: "Strategy where all optional steps fail"
    steps:
      - step_id: "S1_OPT_FAIL_1"
        description: "First optional failure"
        is_required: false
        action:
          type: "CONVERT_IDENTIFIERS_LOCAL"
          input_ontology_type: "hgnc"
          output_ontology_type: "ensembl"
          endpoint_context: "TARGET"
          mapping_path_name: "fail_path_1"
      
      - step_id: "S2_OPT_FAIL_2"
        description: "Second optional failure"
        is_required: false
        action:
          type: "EXECUTE_MAPPING_PATH"
          path_name: "fail_path"
          pass_unmapped: false
      
      - step_id: "S3_OPT_FAIL_3"
        description: "Third optional failure"
        is_required: false
        action:
          type: "FILTER_IDENTIFIERS_BY_TARGET_PRESENCE"
          endpoint_context: "TARGET"
          ontology_type_to_match: "uniprot"
          resource_name_for_check: "fail_resource_3"
          include_if_present: true