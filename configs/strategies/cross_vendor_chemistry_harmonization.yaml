name: CROSS_VENDOR_CHEMISTRY_HARMONIZATION
description: |
  Real-world cross-vendor chemistry test harmonization strategy.
  
  This strategy demonstrates matching chemistry test names between different 
  laboratory vendors (LabCorp, Quest, Mayo) and research datasets (UKBB, Arivale).
  
  Key Features:
  - Handles vendor-specific prefixes (LC, QD, Mayo)
  - Expands common abbreviations (ALT → Alanine Aminotransferase)
  - Matches synonyms (Blood Sugar ↔ Glucose)
  - Expands test panels (BMP → 8 individual tests)
  - Normalizes units (mg/dl → mg/dL)
  
  Expected Input Format:
  source_tests.tsv:
    test_name
    LC123 Glucose
    QD456 ALT (SGPT)
    Mayo TSH
    Basic Metabolic Panel
    Cholesterol, Total
    
  target_tests.tsv:
    test_name
    Blood Sugar
    Alanine Aminotransferase
    Thyroid Stimulating Hormone
    Glucose
    Sodium
    Potassium
    Total Cholesterol

parameters:
  # Real-world test data paths
  labcorp_tests: "/procedure/data/local_data/chemistry/labcorp_test_names.tsv"
  quest_tests: "/procedure/data/local_data/chemistry/quest_test_names.tsv"
  standard_tests: "/procedure/data/local_data/chemistry/loinc_standard_names.tsv"
  output_dir: "/procedure/data/results/chemistry_harmonization"
  
  # High-quality matching settings
  strict_threshold: 0.85
  permissive_threshold: 0.70

steps:
  # Load all test datasets
  - name: load_labcorp_tests
    action:
      type: LOAD_DATASET_IDENTIFIERS
      params:
        file_path: "${parameters.labcorp_tests}"
        identifier_column: "test_name"
        output_key: "labcorp_tests"
        has_header: true
        separator: "\t"

  - name: load_quest_tests
    action:
      type: LOAD_DATASET_IDENTIFIERS
      params:
        file_path: "${parameters.quest_tests}"
        identifier_column: "test_name"
        output_key: "quest_tests"
        has_header: true
        separator: "\t"

  - name: load_standard_tests
    action:
      type: LOAD_DATASET_IDENTIFIERS
      params:
        file_path: "${parameters.standard_tests}"
        identifier_column: "standard_name"
        output_key: "standard_tests"
        has_header: true
        separator: "\t"

  # Primary matching: LabCorp to Standard (strict)
  - name: match_labcorp_to_standard
    action:
      type: CHEMISTRY_FUZZY_TEST_MATCH
      params:
        source_key: "labcorp_tests"
        target_key: "standard_tests"
        output_key: "labcorp_standard_matches"
        
        source_test_column: "test_name"
        target_test_column: "standard_name"
        
        # Strict matching for primary harmonization
        match_threshold: "${parameters.strict_threshold}"
        algorithms: ["exact", "synonym", "abbreviation", "token_sort"]
        
        # Enable advanced features
        handle_vendor_prefixes: true
        handle_panels: true
        use_synonyms: true
        use_abbreviations: true
        normalize_units: true
        
        # Quality tracking
        include_similarity_score: true
        include_match_method: true

  # Secondary matching: Quest to Standard (strict)
  - name: match_quest_to_standard
    action:
      type: CHEMISTRY_FUZZY_TEST_MATCH
      params:
        source_key: "quest_tests"
        target_key: "standard_tests"
        output_key: "quest_standard_matches"
        
        source_test_column: "test_name"
        target_test_column: "standard_name"
        
        match_threshold: "${parameters.strict_threshold}"
        algorithms: ["exact", "synonym", "abbreviation", "token_sort"]
        
        handle_vendor_prefixes: true
        handle_panels: true
        use_synonyms: true
        use_abbreviations: true
        normalize_units: true
        
        include_similarity_score: true
        include_match_method: true

  # Cross-vendor matching: LabCorp to Quest (permissive)
  - name: match_labcorp_to_quest
    action:
      type: CHEMISTRY_FUZZY_TEST_MATCH
      params:
        source_key: "labcorp_tests"
        target_key: "quest_tests"
        output_key: "labcorp_quest_matches"
        
        source_test_column: "test_name"
        target_test_column: "test_name"
        
        # More permissive for cross-vendor matching
        match_threshold: "${parameters.permissive_threshold}"
        algorithms: ["exact", "synonym", "abbreviation", "token_sort", "partial"]
        
        cross_vendor_matching: true
        handle_vendor_prefixes: true
        handle_panels: true
        use_synonyms: true
        use_abbreviations: true
        normalize_units: true
        
        include_similarity_score: true
        include_match_method: true

  # Export all results with detailed statistics
  - name: export_labcorp_standard
    action:
      type: EXPORT_DATASET
      params:
        dataset_key: "labcorp_standard_matches"
        output_file: "${parameters.output_dir}/labcorp_to_standard_matches.tsv"
        format: "tsv"
        include_stats: true

  - name: export_quest_standard
    action:
      type: EXPORT_DATASET
      params:
        dataset_key: "quest_standard_matches"
        output_file: "${parameters.output_dir}/quest_to_standard_matches.tsv"
        format: "tsv"
        include_stats: true

  - name: export_cross_vendor
    action:
      type: EXPORT_DATASET
      params:
        dataset_key: "labcorp_quest_matches"
        output_file: "${parameters.output_dir}/labcorp_to_quest_matches.tsv"
        format: "tsv"
        include_stats: true

  # Generate comprehensive harmonization report
  - name: generate_harmonization_report
    action:
      type: GENERATE_CHEMISTRY_HARMONIZATION_REPORT
      params:
        match_datasets: 
          - "labcorp_standard_matches"
          - "quest_standard_matches"
          - "labcorp_quest_matches"
        output_file: "${parameters.output_dir}/chemistry_harmonization_report.html"
        include_unmatched_analysis: true
        include_quality_metrics: true