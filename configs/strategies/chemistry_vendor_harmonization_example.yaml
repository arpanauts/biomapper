name: CHEMISTRY_VENDOR_HARMONIZATION_EXAMPLE
description: Example strategy demonstrating chemistry vendor harmonization across LabCorp, Quest, and Arivale data

parameters:
  labcorp_file: "/procedure/data/local_data/chemistry/labcorp_test_results.tsv"
  quest_file: "/procedure/data/local_data/chemistry/quest_test_results.tsv"
  arivale_file: "/procedure/data/local_data/chemistry/arivale_test_results.tsv"
  output_dir: "/procedure/data/local_data/outputs/chemistry_harmonized"

steps:
  # Load LabCorp data
  - name: load_labcorp_data
    action:
      type: LOAD_DATASET_IDENTIFIERS
      params:
        file_path: "${parameters.labcorp_file}"
        identifier_column: test_name
        output_key: labcorp_raw
        additional_columns: [test_code, value, unit, reference_range]

  # Load Quest data
  - name: load_quest_data
    action:
      type: LOAD_DATASET_IDENTIFIERS
      params:
        file_path: "${parameters.quest_file}"
        identifier_column: test_name
        output_key: quest_raw
        additional_columns: [test_code, value, unit, reference_range]

  # Load Arivale data
  - name: load_arivale_data
    action:
      type: LOAD_DATASET_IDENTIFIERS
      params:
        file_path: "${parameters.arivale_file}"
        identifier_column: test_name
        output_key: arivale_raw
        additional_columns: [value, unit, reference_range]

  # Harmonize LabCorp data to SI units
  - name: harmonize_labcorp
    action:
      type: CHEMISTRY_VENDOR_HARMONIZATION
      params:
        input_key: labcorp_raw
        output_key: labcorp_harmonized
        vendor: labcorp
        target_unit_system: SI
        standardize_test_names: true
        standardize_units: true
        standardize_reference_ranges: true
        flag_out_of_range: true
        preserve_original: true
        add_harmonization_log: true

  # Harmonize Quest data to SI units
  - name: harmonize_quest
    action:
      type: CHEMISTRY_VENDOR_HARMONIZATION
      params:
        input_key: quest_raw
        output_key: quest_harmonized
        vendor: quest
        target_unit_system: SI
        standardize_test_names: true
        standardize_units: true
        standardize_reference_ranges: true
        flag_out_of_range: true
        preserve_original: true
        add_harmonization_log: true

  # Harmonize Arivale data to SI units
  - name: harmonize_arivale
    action:
      type: CHEMISTRY_VENDOR_HARMONIZATION
      params:
        input_key: arivale_raw
        output_key: arivale_harmonized
        vendor: arivale
        target_unit_system: SI
        standardize_test_names: true
        standardize_units: true
        standardize_reference_ranges: true
        flag_out_of_range: true
        preserve_original: true
        add_harmonization_log: true

  # Merge all harmonized datasets
  - name: merge_harmonized_data
    action:
      type: MERGE_DATASETS
      params:
        dataset_keys: [labcorp_harmonized, quest_harmonized, arivale_harmonized]
        output_key: all_harmonized
        merge_on: test_name_harmonized
        how: outer
        add_source_column: true

  # Calculate overlap between vendors
  - name: calculate_vendor_overlap
    action:
      type: CALCULATE_SET_OVERLAP
      params:
        input_key: all_harmonized
        identifier_column: test_name_harmonized
        group_by_column: vendor_detected
        output_key: vendor_overlap_stats
        calculate_jaccard: true

  # Export harmonized data
  - name: export_harmonized_data
    action:
      type: EXPORT_DATASET
      params:
        input_key: all_harmonized
        output_file: "${parameters.output_dir}/chemistry_harmonized_all_vendors.tsv"
        format: tsv
        include_metadata: true

  # Export vendor statistics
  - name: export_vendor_stats
    action:
      type: EXPORT_DATASET
      params:
        input_key: vendor_overlap_stats
        output_file: "${parameters.output_dir}/vendor_overlap_statistics.tsv"
        format: tsv
        include_metadata: true