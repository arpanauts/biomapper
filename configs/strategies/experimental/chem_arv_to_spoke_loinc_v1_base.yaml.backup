name: CHEM_ARV_TO_SPOKE_LOINC_V1_BASE
description: Maps Arivale chemistry tests to SPOKE clinical labs using LOINC codes and fuzzy name matching

metadata:
  # Required fields
  id: "chem_arv_to_spoke_loinc_v1_base"
  name: "Arivale Chemistry to SPOKE Labs via LOINC"
  version: "1.0.0"
  created: "2025-08-07"
  author: "biomapper-team"
  entity_type: "chemistry"
  source_dataset: "arivale"
  target_dataset: "spoke"
  bridge_type: ["loinc", "fuzzy"]
  
  # Quality tracking
  quality_tier: "experimental"
  validation_status: "pending"
  expected_match_rate: 0.70
  actual_match_rate: null
  
  # Data tracking
  source_files:
    - path: "/procedure/data/local_data/MAPPING_ONTOLOGIES/arivale/chemistries_metadata.tsv"
      last_updated: "2024-06-01"
      row_count: 89
      vendor: "arivale"
  target_files:
    - path: "/procedure/data/local_data/MAPPING_ONTOLOGIES/spoke_ontologies/spoke_clinical_labs.csv"
      last_updated: "2024-10-01"
      row_count: 15000
      standard: "loinc"
  
  # Optional fields
  description: "Maps Arivale chemistry tests to SPOKE clinical labs using LOINC codes and fuzzy name matching"
  tags: ["chemistry", "loinc", "clinical_labs", "arivale", "spoke"]
  dependencies: []
  supersedes: null
  citation: null
  
  # Chemistry-specific metadata
  test_categories:
    - "metabolic_panel"
    - "lipid_panel"
    - "complete_blood_count"
    - "liver_function"
    - "kidney_function"

parameters:
  output_dir: "/tmp/biomapper_output"
  match_threshold: 0.85
  synonym_file: "/procedure/data/local_data/references/lab_test_synonyms.csv"

steps:
  - name: load_arivale_chemistry
    action:
      type: LOAD_DATASET_IDENTIFIERS
      params:
        file_path: "${metadata.source_files[0].path}"
        identifier_column: "test_name"
        output_key: "arivale_chemistry_raw"
  
  - name: load_spoke_labs
    action:
      type: LOAD_DATASET_IDENTIFIERS
      params:
        file_path: "${metadata.target_files[0].path}"
        identifier_column: "loinc_code"
        output_key: "spoke_labs_raw"
  
  - name: extract_arivale_loinc
    action:
      type: CHEMISTRY_EXTRACT_LOINC
      params:
        input_key: "arivale_chemistry_raw"
        test_name_column: "test_name"
        loinc_column: "loinc_code"
        vendor: "arivale"
        output_key: "arivale_chemistry"
  
  - name: extract_spoke_loinc
    action:
      type: CHEMISTRY_EXTRACT_LOINC
      params:
        input_key: "spoke_labs_raw"
        loinc_column: "loinc_code"
        validate_format: true
        output_key: "spoke_labs"
  
  - name: filter_valid_loinc
    action:
      type: FILTER_DATASET
      params:
        input_key: "spoke_labs"
        filter_criteria:
          has_valid_loinc: true
          loinc_pattern: "^\\d{1,5}-\\d$"
        output_key: "spoke_filtered"
  
  - name: fuzzy_test_match
    action:
      type: CHEMISTRY_FUZZY_TEST_MATCH
      params:
        source_key: "arivale_chemistry"
        target_key: "spoke_filtered"
        test_name_column: "test_name"
        match_threshold: "${parameters.match_threshold}"
        use_synonyms: true
        synonym_file: "${parameters.synonym_file}"
        output_key: "fuzzy_matched"
  
  - name: calculate_overlap
    action:
      type: CALCULATE_SET_OVERLAP
      params:
        dataset1_key: "arivale_chemistry"
        dataset2_key: "spoke_filtered"
        output_key: "overlap_statistics"
  
  - name: export_mapping
    action:
      type: EXPORT_DATASET
      params:
        dataset_key: "fuzzy_matched"
        output_path: "${parameters.output_dir}/arivale_spoke_chemistry.tsv"