# Task: Debug Persistent Poetry Dependency Installation Failure

**Task Reference:** User Request
**Execution Date:** 2025-06-25T11:46:51

## 1. Task Objective

Investigate and resolve a persistent and critical issue where the local `biomapper-client` package cannot be correctly installed or recognized within the root project's Poetry virtual environment. The primary goal is to make the `biomapper-client` package importable by scripts executed via `poetry run` or the direct venv Python interpreter.

**Success is defined as:** The script `/home/ubuntu/biomapper/scripts/main_pipelines/run_full_ukbb_hpa_mapping.py` executes successfully without raising an `ImportError` for `biomapper_client`.

## 2. Service Architecture Context

This is a fundamental development environment setup issue, not a service runtime problem. It affects the interaction between two local packages within a monorepo structure managed by Poetry:

- **Primary Project:** `biomapper` (root directory)
- **Local Dependency:** `biomapper_client` (subdirectory)

The failure prevents the execution of any script that relies on the client SDK, blocking all further development and testing of the service-oriented architecture.

## 3. Prerequisites

- A functional Poetry installation.
- The current state of the `biomapper` repository.
- All previous attempts to fix this have failed, so a fresh perspective is required.

## 4. Key Information & Debugging History

The core problem is that despite being installed through various methods, the `biomapper-client` package is not found at runtime.

**The Error:**
```
Error: The 'biomapper-client' package is not installed.
Please install it by running 'pip install -e biomapper_client' from the project root.
```

**Chronological Debugging Steps Taken (All Failed):**

1.  **Initial State:** The script `run_full_ukbb_hpa_mapping.py` was updated to use the `biomapper_client`.
2.  **Attempt 1: Standard Install:** Ran `poetry install` from the root. The error persisted.
3.  **Attempt 2: Editable Pip Install:** Ran `poetry run pip install -e biomapper-client/`. This failed, indicating the directory was not a valid editable requirement.
4.  **Attempt 3: Nested Poetry Install:** Navigated to `/home/ubuntu/biomapper/biomapper_client/` and ran `poetry install`. The command succeeded, but the error persisted when running the script from the root.
5.  **Attempt 4: Add Path Dependency:** Modified the root `/home/ubuntu/biomapper/pyproject.toml` to include `biomapper-client = {path = "biomapper_client", develop = true}`.
6.  **Problem 4a: Lock File Loop:** This led to a loop where `poetry install` would demand `poetry lock` be run, and `poetry lock` would not resolve correctly.
7.  **Attempt 5: Resolve Dependency Conflict:** A Dependabot alert revealed a version conflict with `h11` (a sub-dependency of `httpx`).
    - Upgraded `httpx` in `biomapper_client/pyproject.toml` from `^0.24.0` to `^0.27.0`.
    - Aligned `pydantic` version to `^2.11.4` in the client to match the root project.
8.  **Attempt 6: Fresh Lock File:** After fixing conflicts, the lock file loop persisted. The `poetry.lock` file was deleted and regenerated by running `poetry install` from the root. This appeared to succeed.
9.  **Final Failure:** Despite a seemingly successful installation, running the script with both `poetry run python ...` and `/home/ubuntu/biomapper/.venv/bin/python ...` resulted in the exact same `ImportError`.

**Relevant File Contents:**

-   **Root `pyproject.toml` (`/home/ubuntu/biomapper/pyproject.toml`):**
    ```toml
    [tool.poetry.dependencies]
    ...
    adjusttext = "^1.3.0"
    biomapper-client = {path = "biomapper_client", develop = true}
    ...
    ```

-   **Client `pyproject.toml` (`/home/ubuntu/biomapper/biomapper_client/pyproject.toml`):**
    ```toml
    [tool.poetry.dependencies]
    python = "^3.8"
    httpx = "^0.27.0"
    pydantic = "^2.11.4"
    ```

## 5. Detailed Task Breakdown for Investigation

A new approach is needed. Do not repeat the failed steps above.

1.  **Deep Environment Inspection:**
    - From the root directory, run `poetry show --tree` to see if `biomapper-client` appears in the dependency tree at all.
    - Run `poetry check` to validate the `pyproject.toml` file's consistency.
    - Manually inspect the contents of `/home/ubuntu/biomapper/.venv/lib/python3.11/site-packages/` to see if a `.pth` file or a directory for `biomapper_client` was created.

2.  **Isolate the Installation:**
    - Temporarily remove the `biomapper-client` path dependency from the root `pyproject.toml`.
    - Run `poetry lock` and `poetry install` to get the environment to a stable state without the client.
    - Try installing the client using a different method. Navigate to `/home/ubuntu/biomapper/biomapper_client` and build a wheel (`poetry build`). Then, from the root, install the generated wheel file directly using `poetry run pip install /path/to/wheel.whl`.

3.  **Debug Poetry Itself:**
    - Run the failing command with maximum verbosity to get more insight: `poetry -vvv run python scripts/main_pipelines/run_full_ukbb_hpa_mapping.py`. Analyze the output for clues about how the `PYTHONPATH` is being constructed.

4.  **Propose a Structural Change:**
    - If the nested project structure is deemed the root cause, propose a more standard monorepo structure. For example, moving all source code (for the core lib, api, and client) into a `src/` directory and configuring `pyproject.toml` to manage them as a single project with extras.

## 6. Error Recovery Instructions

- If any command fails, analyze the verbose output carefully.
- Do not get stuck in a `lock`/`install` loop. If it occurs, delete `poetry.lock` and the `.venv` directory to start from a completely clean slate.

## 7. Success Criteria and Validation

The task is complete when:
- [ ] The command `poetry run python scripts/main_pipelines/run_full_ukbb_hpa_mapping.py` runs from the root directory without an `ImportError`.
- [ ] The root cause of the installation failure is identified and documented.
- [ ] The fix is robust and follows Python packaging best practices.

## 8. Feedback Requirements

Create a detailed Markdown feedback file at:
`[PROJECT_ROOT]/roadmap/_active_prompts/feedback/YYYY-MM-DD-HHMMSS-feedback-fix-poetry-client-install.md`

The feedback must include:
- A clear explanation of the root cause.
- The exact steps required to fix the issue.
- Any changes made to `pyproject.toml` or other configuration files.
