# Prompt for Claude Code Instance: Fix MappingExecutor Path Selection Logic

## 1. Source Prompt Reference
This prompt was generated by Cascade based on USER REQUEST (Step Id: 764) on 2025-05-29 to address issues with `MappingExecutor` path selection. Context can be found in `/home/ubuntu/biomapper/roadmap/_status_updates/2025-05-28-gene-mapping-executor-issue.md` and `/home/ubuntu/biomapper/roadmap/_status_updates/_suggested_next_prompt.md`.

## 2. Task Definition
The primary task is to debug and modify the path selection logic within the `MappingExecutor` class, specifically in the `_get_mapping_paths` method (and any related helper methods). The goal is to ensure that `MappingExecutor` correctly prioritizes and selects mapping paths based on the `priority` field defined in the `metamapper.db` and effectively utilizes user-defined, higher-priority paths over potentially problematic default or identity paths.

## 3. Background
The Biomapper system uses `MappingExecutor` to find and execute mapping paths between different biological data endpoints. Recently, a workaround was implemented to map UKBB protein identifiers (UniProtKB AC) to HPA protein identifiers by targeting their Gene Names instead of directly mapping UniProtKB AC to UniProtKB AC. This was done because the `MappingExecutor` has shown issues with "identity" mappings where the source and target ontology types are the same across different endpoints.

A new mapping path, `UKBB_UniProt_to_HPA_GeneName` (source: `UNIPROTKB_AC`, target: `GENE_NAME`), was defined with `priority=1` in `/home/ubuntu/biomapper/scripts/populate_metamapper_db.py` for the `EndpointRelationship` between "UKBB_Protein" and "HPA_Protein".

## 4. Problem Statement
Despite the `UKBB_UniProt_to_HPA_GeneName` path having a `priority=1` (higher priority), the `MappingExecutor` currently selects a different, presumably lower-priority or default-priority, "identity" path (source: `UNIPROTKB_AC`, target: `UNIPROTKB_AC`) when attempting to map between UKBB_Protein and HPA_Protein. This identity path is known to be problematic and results in failed mappings for this specific relationship.

The QIN mapping (UKBB UniProtKB AC to QIN Gene Name) works correctly because no such conflicting UniProtKB AC identity path was defined for the QIN endpoint relationship, forcing the selection of the gene name path.

This indicates a flaw in how `MappingExecutor._get_mapping_paths` discovers, filters, or orders potential mapping paths, particularly concerning the `priority` attribute.

## 5. Goal
Modify the `MappingExecutor`'s path selection logic so that it correctly prioritizes and selects the `UKBB_UniProt_to_HPA_GeneName` path (which has `priority=1`) when resolving the mapping for the `EndpointRelationship` between "UKBB_Protein" and "HPA_Protein". The solution should make the `priority` field in the `MappingPath` table an effective mechanism for guiding path selection.

## 6. Key Files & Code Sections
-   **Primary focus:** `/home/ubuntu/biomapper/src/biomapper/mapping_executor.py`
    -   Class: `MappingExecutor`
    -   Method: `_get_mapping_paths(self, source_endpoint: models.Endpoint, target_endpoint: models.Endpoint, source_ontology_type: str, target_ontology_type: str) -> Sequence[models.MappingPath]`
-   **For context on path definitions and priorities:** `/home/ubuntu/biomapper/scripts/populate_metamapper_db.py`
    -   Search for `UKBB_UniProt_to_HPA_GeneName` and `ukbb_protein_to_hpa_protein`.
-   **For model definitions:** `/home/ubuntu/biomapper/src/biomapper/metamapper_db/models.py`
    -   Class: `MappingPath` (note the `priority` field, which is an `Optional[int]`)
    -   Class: `RelationshipMappingPath` (links `EndpointRelationship` to `MappingPath`)

## 7. Areas for Investigation
1.  **SQLAlchemy Query in `_get_mapping_paths`:**
    -   Examine the `select` statement. How are paths currently filtered based on `source_endpoint`, `target_endpoint`, `source_ontology_type`, and `target_ontology_type`?
    -   How are paths ordered? Is `MappingPath.priority` currently used in an `order_by` clause?
2.  **Handling of `priority`:**
    -   If `priority` is used, why is it not resulting in the selection of the `priority=1` path?
    -   If `priority` is `None` for some paths, how does this affect ordering compared to paths with an explicit priority? (Standard SQL might treat NULLs differently in ordering).
3.  **Implicit Bias for Identity Mappings:**
    -   Is there any logic that gives preference to paths where `MappingPath.source_type == MappingPath.target_type` (identity ontology paths), potentially overriding the explicit `priority` field?
4.  **Path Resolution from `RelationshipMappingPath`:**
    -   The `MappingExecutor.execute_mapping_by_relationship` method first gets `RelationshipMappingPath` entries. How does it then use the `ontology_path_id` from these to fetch the actual `MappingPath` and its priority?

## 8. Suggested Approaches (Implement the most appropriate)
1.  **Strict Priority Ordering:**
    -   Ensure that the SQLAlchemy query in `_get_mapping_paths` (or subsequent processing of its results) explicitly orders the selected paths by `MappingPath.priority` in ascending order (lower numbers = higher priority). Paths with `NULL` priority should be treated as lower priority than those with explicit numerical priorities.
    -   The method should then select the highest priority path from this ordered list.
2.  **Refine Filtering Logic:**
    -   If there's logic that overly favors identity paths, adjust it to ensure explicit priorities take precedence.
    -   Consider how `RelationshipMappingPath` entries are used. The selection should ultimately respect the priority of the `MappingPath` linked by `RelationshipMappingPath.ontology_path_id`.

## 9. Inputs
-   The current Biomapper codebase, particularly the files listed in section 6.
-   Contextual information from:
    -   `/home/ubuntu/biomapper/roadmap/_status_updates/2025-05-28-gene-mapping-executor-issue.md`
    -   The `iterative_mapping_strategy.md` document if general mapping concepts are unclear.

## 10. Outputs/Deliverables
1.  **Modified Code:**
    -   The updated `/home/ubuntu/biomapper/src/biomapper/mapping_executor.py` file with the corrected path selection logic.
2.  **Feedback File (`YYYY-MM-DD-HHMMSS-feedback-fix-mapping-executor-path-priority.md`):**
    -   A clear explanation of the root cause of the incorrect path selection.
    -   Detailed description of the changes made to `MappingExecutor` to address the issue.
    -   Confirmation of how the new logic will ensure the `UKBB_UniProt_to_HPA_GeneName` path is chosen for the UKBB to HPA endpoint relationship, given its `priority=1`.
    -   Any assumptions made or potential side effects considered.

## 11. Testing Guidance (For you to verify your fix)
-   After applying your changes, mentally trace or add temporary debug logging to `MappingExecutor._get_mapping_paths` and `MappingExecutor.execute_mapping_by_relationship`.
-   Confirm that when resolving the mapping for the `EndpointRelationship` between "UKBB_Protein" and "HPA_Protein" (which is linked to the `UKBB_UniProt_to_HPA_GeneName` path via `RelationshipMappingPath`), your modified logic would indeed select `UKBB_UniProt_to_HPA_GeneName` as the highest-priority, valid path.
-   The ultimate test by the USER will involve running `/home/ubuntu/biomapper/scripts/populate_metamapper_db.py --drop-all` and then `/home/ubuntu/biomapper/scripts/map_ukbb_to_hpa.py`.

## 12. Constraints
-   The solution should primarily focus on making the existing `priority` system effective as defined in `models.MappingPath`.
-   Strive for clarity and maintainability in the code.
-   Ensure that the changes do not negatively impact other existing mapping scenarios that might be working correctly (e.g., UKBB to Arivale, or the UKBB to QIN gene name mapping). The fix should be targeted at how priorities are handled in general.
