# Task: Diagnose and Fix Persistent SQLite Connection Error

**Source Prompt Reference:** This task is defined by the prompt at `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/roadmap/_active_prompts/2025-06-18-033559-fix-and-validate.md`

## 1. Task Objective
Diagnose and permanently resolve the recurring `sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) unable to open database file` error. This error prevents any script that requires a database connection from running, blocking all further development and testing.

## 2. Prerequisites
- **Required files exist:** The project structure is in place. Key files for this task are:
  - `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/config.py`
  - `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/db/session.py`
  - `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/scripts/setup_and_configuration/populate_metamapper_db.py`
- **Environment state:** The `pyenv` environment is correctly set up with all dependencies installed via Poetry.

## 3. Context from Previous Attempts
Multiple attempts have been made to resolve this issue, but it persists. Understanding these failures is critical.

- **Initial Failure:** The main pipeline script (`run_full_ukbb_hpa_mapping.py`) failed with the `unable to open database file` error.
- **Second Failure:** The database setup script (`populate_metamapper_db.py`) also failed with the exact same error, indicating the problem is with database creation, not just access.
- **Hypothesis 1 (Pathing Issue):** It was suspected that the database path construction in `biomapper/config.py`, which used `Path(__file__).parent.parent` to define an absolute path, was faulty. 
- **Attempted Fix 1 (Relative Paths):** The logic in `config.py` was changed to use simple relative paths (e.g., `sqlite+aiosqlite:///data/metamapper.db`).
- **Third Failure (Syntax Error):** This change introduced an `IndentationError` in `config.py`.
- **Attempted Fix 2 (Indentation):** The `IndentationError` was corrected.
- **Fourth Failure (Error Persists):** Even after fixing the indentation and using relative paths, running `populate_metamapper_db.py` **still results in the `unable to open database file` error.**

**Conclusion:** The root cause is not simply the path string in `config.py`. The problem likely lies in how that path is processed and used to create the database file and its parent directory within `biomapper/db/session.py`.

## 4. Task Decomposition
1.  **Diagnose the Path Resolution:** Modify `biomapper/db/session.py` to add diagnostic logging. Specifically, in the `DatabaseManager.__init__` method, print the absolute path that is being derived from the relative `db_url` before the code attempts to create the directory. This will reveal exactly where the application is trying (and failing) to create the database file.
2.  **Implement the Fix:** Based on the diagnosis, implement a robust fix. The current logic (`db_path.parent.mkdir(parents=True, exist_ok=True)`) is failing. The fix might involve resolving the path relative to a known anchor, like the project's root directory, before creating it. A reliable way to get the project root is needed, as the previous `Path(__file__)` method proved unreliable.
3.  **Validate the Fix:** After applying the fix, run the database population script. It must complete without errors.
    - **Command:** `python scripts/setup_and_configuration/populate_metamapper_db.py`
4.  **Full System Validation:** Once the database is successfully created, run the main mapping pipeline to ensure the fix works for the entire application.
    - **Command:** `python scripts/main_pipelines/run_full_ukbb_hpa_mapping.py`

## 5. Implementation Requirements
- **Input files/data:** 
  - `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/config.py`
  - `/home/ubuntu/Software-Engineer-AI-Agent-Atlas/biomapper/biomapper/db/session.py`
- **Expected outputs:** A fully functional database connection system. No new files are expected, only modifications to the existing ones.
- **Code standards:** All changes must be clean, well-documented, and follow existing project conventions.

## 6. Error Recovery Instructions
- If diagnostic logging doesn't reveal the issue, consider filesystem permissions. However, this is unlikely to be the root cause.
- The most probable point of failure is the path resolution logic. Focus your efforts on ensuring the relative path from `config.py` is correctly converted to a valid, writable absolute path on the filesystem within `session.py`.

## 7. Success Criteria and Validation
Task is complete when:
- [ ] The `populate_metamapper_db.py` script executes successfully from the project root, creating the `data/metamapper.db` file.
- [ ] The `run_full_ukbb_hpa_mapping.py` script starts execution without the `unable to open database file` error.

## 8. Feedback Requirements
Create a detailed Markdown feedback file at:
`[PROJECT_ROOT]/roadmap/_active_prompts/feedback/YYYY-MM-DD-HHMMSS-feedback-fix-sqlite-connection.md`

**Mandatory Feedback Sections:**
- **Execution Status:** [COMPLETE_SUCCESS | FAILED_WITH_RECOVERY_OPTIONS]
- **Root Cause Analysis:** A clear explanation of why the error was occurring.
- **Summary of Changes:** A description of the code modifications made to fix the error.
- **Validation Steps:** Confirmation that both validation scripts were executed successfully.
