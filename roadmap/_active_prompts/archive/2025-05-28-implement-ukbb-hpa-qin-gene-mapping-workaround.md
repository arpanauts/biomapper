---
**Prompt for Claude Code Instance**
---

**Suggested Filename:** `2025-05-28-implement-ukbb-hpa-qin-gene-mapping-workaround.md`
**Date:** 2025-05-28
**Originating Request:** User Request (Step ID 712), based on conversation with Cascade.
**Parent Prompt Reference:** This prompt is generated by Cascade based on User Request ID Step 712.

---
**1. High-Level Objective**
---

Modify the Biomapper system to enable mapping from UKBB protein identifiers (UniProtKB Accession Numbers) to Human Protein Atlas (HPA) and QIN proteomics study protein identifiers by using their respective Gene Names as the target. This change serves as a workaround to bypass a suspected issue with identity ontology mappings (e.g., `UNIPROTKB_AC` -> `UNIPROTKB_AC`) within the current `MappingExecutor` logic.

---
**2. Background and Context**
---

The Biomapper's `MappingExecutor` is currently failing to discover defined mapping paths when the source and target ontology types are identical (e.g., `UNIPROTKB_AC` to `UNIPROTKB_AC`). This results in zero successful mappings for the UKBB to HPA UniProt identity mapping task, despite a valid path (Path ID 16: `UKBB_Protein_to_HPA_Protein_UniProt_Identity`) being defined in `metamapper.db` and linked via the `relationship_mapping_paths` table.

However, mappings where source and target ontology types differ (e.g., UKBB's `UNIPROTKB_AC` to Arivale's `ARIVALE_PROTEIN_ID`) are successful. This suggests the path discovery logic for non-identity ontology mappings is functional.

This task implements a workaround by reconfiguring the UKBB to HPA and UKBB to QIN mappings to target `GENE_NAME` instead of `UNIPROTKB_AC`. This transforms them into non-identity ontology mappings (`UNIPROTKB_AC` -> `GENE_NAME`), which are expected to work with the current `MappingExecutor`.

**Source Data Files:**
*   UKBB Input: `/home/ubuntu/biomapper/data/UKBB_Protein_Meta_full.tsv` (Contains 'UniProt' column for UniProtKB ACs)
*   HPA Data: `/home/ubuntu/biomapper/data/isb_osp/hpa_osps.csv` (Contains 'uniprot' and 'gene' columns)
*   QIN Data: `/home/ubuntu/biomapper/data/isb_osp/qin_osps.csv` (Contains 'uniprot' and 'gene' columns)

---
**3. Detailed Tasks and Implementation Steps**
---

### Task 3.1: Update Database Population Script (`populate_metamapper_db.py`)

**Location:** `/home/ubuntu/biomapper/scripts/populate_metamapper_db.py`

**3.1.a. Ensure `GENE_NAME` Ontology:**
   - Verify if an ontology for gene names (e.g., `GENE_NAME` or `HGNC_SYMBOL`) is defined within the `ontologies` dictionary.
   - If not, add a new `Ontology` definition. Use the key `"gene_name"` for this ontology.
     ```python
     # Example if adding new:
     "gene_name": models.Ontology(
         name="GENE_NAME",
         description="Official Gene Symbol or Common Gene Name",
         # identifier_prefix="HGNC:", # Optional: if aligning with HGNC
         # namespace_uri="https://www.genenames.org/data/gene-symbol-report/#!/", # Optional
     ),
     ```
   - Ensure this new ontology object is added to the database session.

**3.1.b. Update/Add Properties for HPA and QIN Endpoints:**
   - **HPA Endpoint (`hpa_protein`):**
     - Locate the `hpa_protein` endpoint definition in the `endpoints` dictionary.
     - Add/Modify two `Property` objects associated with this endpoint:
       1.  For its 'gene' column (target property):
           ```python
           models.Property(
               name="gene", # Matches column name in hpa_osps.csv
               description="Gene name for HPA protein",
               ontology_id=ontologies["gene_name"].id, # Use ID of the GENE_NAME ontology
               endpoint_id=endpoints["hpa_protein"].id,
               is_primary=True, # Mark as primary target for this mapping scenario
               data_type="string"
           ),
           ```
       2.  For its 'uniprot' column (lookup key):
           ```python
           models.Property(
               name="uniprot", # Matches column name in hpa_osps.csv
               description="UniProt Accession for HPA protein (lookup key)",
               ontology_id=ontologies["uniprotkb_ac"].id, # Assuming "uniprotkb_ac" is key for UniProtKB AC ontology
               endpoint_id=endpoints["hpa_protein"].id,
               is_primary=False, # Not the primary target of this mapping
               data_type="string"
           ),
           ```
   - **QIN Endpoint (New or Existing):**
     - If an endpoint for QIN proteomics data doesn't exist, define it (e.g., key `"qin_protein"`).
       ```python
       # Example if adding new:
       "qin_protein": models.Endpoint(
           name="QIN_Protein",
           description="QIN Proteomics Data from ISB-OSP study",
           # source_data_url="<URL_if_known_or_NA>" # Optional
       ),
       ```
     - Add two `Property` objects for its `gene` and `uniprot` columns, similar to HPA:
       1.  For 'gene':
           ```python
           models.Property(
               name="gene", # Matches column name in qin_osps.csv
               description="Gene name for QIN protein",
               ontology_id=ontologies["gene_name"].id,
               endpoint_id=endpoints["qin_protein"].id,
               is_primary=True,
               data_type="string"
           ),
           ```
       2.  For 'uniprot':
           ```python
           models.Property(
               name="uniprot", # Matches column name in qin_osps.csv
               description="UniProt Accession for QIN protein (lookup key)",
               ontology_id=ontologies["uniprotkb_ac"].id,
               endpoint_id=endpoints["qin_protein"].id,
               is_primary=False,
               data_type="string"
           ),
           ```

**3.1.c. Configure Mapping Resources:**
   - **HPA Protein Lookup (`hpa_protein_lookup`):**
     - This resource likely uses `LocalFileLookupClient`. Update its definition in the `resources` dictionary:
       ```python
       "hpa_protein_lookup": models.MappingResource(
           name="HPA_Protein_Lookup_UniProt_to_Gene",
           description="Looks up HPA gene names by UniProt AC from hpa_osps.csv.",
           client_type="LocalFileLookupClient",
           client_config={
               "file_path": "/home/ubuntu/biomapper/data/isb_osp/hpa_osps.csv",
               "delimiter": ",",
               "source_property_name": "uniprot", # Column in hpa_osps.csv to match input UniProt AC
               "target_property_name": "gene",   # Column in hpa_osps.csv to return as Gene Name
           },
           version="1.0", # Example version
           # data_source_url="<URL_to_HPA_data_source_if_known>" # Optional
       ),
       ```
   - **QIN Protein Lookup (New Resource):**
     - Define a new `MappingResource` for QIN in the `resources` dictionary, key `"qin_protein_lookup"`:
       ```python
       "qin_protein_lookup": models.MappingResource(
           name="QIN_Protein_Lookup_UniProt_to_Gene",
           description="Looks up QIN gene names by UniProt AC from qin_osps.csv.",
           client_type="LocalFileLookupClient",
           client_config={
               "file_path": "/home/ubuntu/biomapper/data/isb_osp/qin_osps.csv",
               "delimiter": ",",
               "source_property_name": "uniprot", # Column in qin_osps.csv to match input UniProt AC
               "target_property_name": "gene",   # Column in qin_osps.csv to return as Gene Name
           },
           version="1.0", # Example version
           # data_source_url="<URL_to_QIN_data_source_if_known>" # Optional
       ),
       ```

**3.1.d. Define New Mapping Paths:**
   - Add the following to the `paths` dictionary:
   - **UKBB UniProt to HPA GeneName:**
     ```python
     "UKBB_UniProt_to_HPA_GeneName": models.MappingPath(
         name="UKBB_UniProt_to_HPA_GeneName",
         source_type="UNIPROTKB_AC",
         target_type="GENE_NAME", # Target the GENE_NAME ontology
         priority=1, # High priority
         description="Maps UKBB UniProtKB AC to HPA Gene Name using hpa_osps.csv.",
         steps=[
             models.MappingPathStep(
                 mapping_resource_id=resources["hpa_protein_lookup"].id, # Use the reconfigured HPA lookup
                 step_order=1,
                 description="Lookup HPA Gene Name from UniProt AC."
             )
         ],
     ),
     ```
   - **UKBB UniProt to QIN GeneName:**
     ```python
     "UKBB_UniProt_to_QIN_GeneName": models.MappingPath(
         name="UKBB_UniProt_to_QIN_GeneName",
         source_type="UNIPROTKB_AC",
         target_type="GENE_NAME", # Target the GENE_NAME ontology
         priority=1, # High priority
         description="Maps UKBB UniProtKB AC to QIN Gene Name using qin_osps.csv.",
         steps=[
             models.MappingPathStep(
                 mapping_resource_id=resources["qin_protein_lookup"].id, # Use the new QIN lookup
                 step_order=1,
                 description="Lookup QIN Gene Name from UniProt AC."
             )
         ],
     ),
     ```

**3.1.e. Link Mapping Paths to Endpoint Relationships:**
   - Ensure `EndpointRelationship` definitions exist for UKBB Protein to HPA Protein (e.g., key `ukbb_protein_to_hpa_protein`) and UKBB Protein to QIN Protein (e.g., key `ukbb_protein_to_qin_protein`) in the `relationships` dictionary. Create them if they don't exist, using the IDs of the `ukbb_protein`, `hpa_protein`, and `qin_protein` endpoints.
   - In the `relationship_mapping_paths_data` list (or equivalent structure that populates the `relationship_mapping_paths` table), add entries to link these new paths:
     ```python
     # Example:
     (
         relationships["ukbb_protein_to_hpa_protein"].id,
         paths["UKBB_UniProt_to_HPA_GeneName"].id,
         "UNIPROTKB_AC", "GENE_NAME"
     ),
     (
         relationships["ukbb_protein_to_qin_protein"].id,
         paths["UKBB_UniProt_to_QIN_GeneName"].id,
         "UNIPROTKB_AC", "GENE_NAME"
     ),
     ```
   - **Crucial:** Ensure all objects (Ontologies, Properties, Endpoints, MappingResources, MappingPaths, EndpointRelationships) are added to the session and flushed appropriately to obtain IDs before they are referenced as foreign keys.

### Task 3.2: Update UKBB to HPA Mapping Script

**Location:** `/home/ubuntu/biomapper/scripts/map_ukbb_to_hpa.py`

   - Modify the script constants/configurations:
     - `UKBB_INPUT_FILE_PATH = "/home/ubuntu/biomapper/data/UKBB_Protein_Meta_full.tsv"`
     - `UKBB_IDENTIFIER_COLUMN = "UniProt"` (Column in UKBB file containing UniProt ACs)
     - `SOURCE_PROPERTY_NAME = "UniProt"` (Corresponds to `UKBB_IDENTIFIER_COLUMN` for clarity with executor)
     - `SOURCE_ONTOLOGY_TYPE = "UNIPROTKB_AC"`
     - `HPA_ENDPOINT_NAME` should match the `name` field of the HPA endpoint in `populate_metamapper_db.py` (e.g., `"HPA_Protein"`). Set `TARGET_ENDPOINT_NAME = HPA_ENDPOINT_NAME`.
     - `TARGET_PROPERTY_NAME = "gene"` (The target property on HPA endpoint we want to map to, as defined in 3.1.b).
     - `TARGET_ONTOLOGY_TYPE = "GENE_NAME"` (The target ontology type).
     - `OUTPUT_FILE_PATH` (e.g., `"/home/ubuntu/biomapper/output/ukbb_to_hpa_gene_mapped.tsv"`).

### Task 3.3: Create UKBB to QIN Mapping Script

**Location:** `/home/ubuntu/biomapper/scripts/map_ukbb_to_qin.py` (New file)

   - Create this new script, likely by copying and modifying the updated `map_ukbb_to_hpa.py`.
   - **Modify constants/configurations:**
     - `UKBB_INPUT_FILE_PATH = "/home/ubuntu/biomapper/data/UKBB_Protein_Meta_full.tsv"`
     - `UKBB_IDENTIFIER_COLUMN = "UniProt"`
     - `SOURCE_PROPERTY_NAME = "UniProt"`
     - `SOURCE_ONTOLOGY_TYPE = "UNIPROTKB_AC"`
     - `QIN_ENDPOINT_NAME` should match the `name` field of the QIN endpoint in `populate_metamapper_db.py` (e.g., `"QIN_Protein"`). Set `TARGET_ENDPOINT_NAME = QIN_ENDPOINT_NAME`.
     - `TARGET_PROPERTY_NAME = "gene"`
     - `TARGET_ONTOLOGY_TYPE = "GENE_NAME"`
     - `OUTPUT_FILE_PATH` (e.g., `"/home/ubuntu/biomapper/output/ukbb_to_qin_gene_mapped.tsv"`).
   - Ensure the script correctly initializes `MappingExecutor` and calls its `execute_mapping_pipeline` method with these configurations.

---
**4. Inputs**
---

*   **Scripts to Modify/Create:**
    *   `/home/ubuntu/biomapper/scripts/populate_metamapper_db.py`
    *   `/home/ubuntu/biomapper/scripts/map_ukbb_to_hpa.py`
    *   `/home/ubuntu/biomapper/scripts/map_ukbb_to_qin.py` (new)
*   **Data Files (Read-only for this task):**
    *   `/home/ubuntu/biomapper/data/UKBB_Protein_Meta_full.tsv`
    *   `/home/ubuntu/biomapper/data/isb_osp/hpa_osps.csv`
    *   `/home/ubuntu/biomapper/data/isb_osp/qin_osps.csv`
*   **Database:** `metamapper.db` (will be repopulated). Location: `/home/ubuntu/biomapper/metamapper.db`

---
**5. Expected Outputs/Deliverables**
---

*   Modified `/home/ubuntu/biomapper/scripts/populate_metamapper_db.py` with new/updated ontology, properties, resources, paths, and relationships.
*   Modified `/home/ubuntu/biomapper/scripts/map_ukbb_to_hpa.py` configured for UKBB (UniProt) to HPA (Gene Name) mapping.
*   New `/home/ubuntu/biomapper/scripts/map_ukbb_to_qin.py` configured for UKBB (UniProt) to QIN (Gene Name) mapping.
*   Successful execution of these scripts, resulting in:
    *   A repopulated `/home/ubuntu/biomapper/metamapper.db` with the new configurations.
    *   Output mapping files (e.g., `/home/ubuntu/biomapper/output/ukbb_to_hpa_gene_mapped.tsv`, `/home/ubuntu/biomapper/output/ukbb_to_qin_gene_mapped.tsv`) containing successfully mapped records.
    *   Console logs indicating successful path discovery and non-zero mapping counts for both HPA and QIN.

---
**6. Constraints and Important Considerations**
---

*   **Workaround:** This implementation is a workaround. The root cause of identity ontology mapping failures in `MappingExecutor` should be investigated separately.
*   **Database Recreation:** The `populate_metamapper_db.py` script should be run with the `--drop-all` flag to ensure a clean database state reflecting the new schema and data.
*   **Idempotency:** While `--drop-all` handles it, strive for `populate_metamapper_db.py` to be as close to idempotent as possible (e.g., by checking for existence before adding, though this is less critical when dropping all).
*   **Error Handling:** The mapping scripts should include basic error handling or logging to help diagnose issues.
*   **Clarity of Code:** Ensure all new or modified code is clear, well-commented, and follows existing project conventions.
*   **Absolute Paths:** All file paths in configurations and scripts must be absolute.

---
**7. Testing and Validation**
---

1.  After implementing all changes, execute:
    ```bash
    python /home/ubuntu/biomapper/scripts/populate_metamapper_db.py --drop-all
    ```
    Verify it completes without errors.
2.  Execute the mapping scripts:
    ```bash
    python /home/ubuntu/biomapper/scripts/map_ukbb_to_hpa.py
    python /home/ubuntu/biomapper/scripts/map_ukbb_to_qin.py
    ```
3.  Monitor console output for:
    *   `MappingExecutor` logs indicating path discovery (e.g., "Found N mapping paths...").
    *   Logs indicating the number of successful mappings (e.g., "Mapped X out of Y records...").
4.  Inspect the content of the generated output TSV files in `/home/ubuntu/biomapper/output/` to confirm mappings are as expected.

---
**End of Prompt**
---
