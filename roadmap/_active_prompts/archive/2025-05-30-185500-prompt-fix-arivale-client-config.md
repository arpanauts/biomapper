# Prompt for Fixing Arivale Client Configurations in metamapper.db

**ID:** 2025-05-30-185500-prompt-fix-arivale-client-config
**Source Prompt Reference:** Feedback from MappingExecutor performance testing: `/home/ubuntu/biomapper/roadmap/_active_prompts/feedback/2025-05-30-185108-feedback-mapping-executor-perf-test.md` (Task initiated by Cascade AI)
**Project:** Biomapper
**Generated by:** Cascade AI (Project Manager)
**Date:** 2025-05-30

## 1. Task Definition

Investigate and correct the JSON configuration template errors for Arivale-related mapping resources within the `metamapper.db`. These errors were identified during recent `MappingExecutor` performance tests and prevented successful mappings, although they did not impede the performance measurements themselves.

The goal is to ensure that all Arivale client configurations in `metamapper.db` are valid and allow for successful data loading and mapping operations by their respective clients, particularly `ArivaleMetadataLookupClient` and `ArivaleReverseLookupClient`.

## 2. Context

The `MappingExecutor` relies on `metamapper.db` (populated by `/home/ubuntu/biomapper/scripts/populate_metamapper_db.py`) to store configurations for various mapping clients. The feedback from performance testing (MEMORY[94289870-9951-4754-8943-891449543435]) indicated that JSON parsing errors occurred for Arivale client configuration templates.

Relevant files and components:
*   `populate_metamapper_db.py`: `/home/ubuntu/biomapper/scripts/populate_metamapper_db.py` (This script defines and inserts the configurations)
*   `ArivaleMetadataLookupClient`: `/home/ubuntu/biomapper/biomapper/mapping/clients/arivale_lookup_client.py` (Uses the configuration)
*   `ArivaleReverseLookupClient`: (Likely uses similar configuration patterns, often part of `ArivaleMetadataLookupClient` or a similar structure)
*   `metamapper.db`: The SQLite database containing the configurations. Path accessible via `from biomapper.config import settings; settings.metamapper_db_url`.
*   Arivale Proteomics Metadata: `/procedure/data/local_data/ARIVALE_SNAPSHOTS/proteomics_metadata.tsv` (The file these clients are configured to read).

Memory references:
*   Performance Test Feedback: MEMORY[94289870-9951-4754-8943-891449543435]
*   `populate_metamapper_db.py` updates for UKBB/Arivale: MEMORY[b6812ec3-907e-4aea-8aa4-ed198c4ce442]
*   Blueprint for `populate_metamapper_db.py` updates: MEMORY[c3f81352-4385-4f0e-b00f-c46577cbec43]
*   `ArivaleMetadataLookupClient` bug (reverse_map_identifiers): MEMORY[f6894b86-bc38-4b64-8aa8-f8251df7daef] (Ensure this fix is still compatible with any config changes).

## 3. Input Materials

*   Script for populating the database: `/home/ubuntu/biomapper/scripts/populate_metamapper_db.py`
*   Arivale client code: `/home/ubuntu/biomapper/biomapper/mapping/clients/arivale_lookup_client.py`
*   The `metamapper.db` itself (path from `settings.metamapper_db_url`).
*   Arivale data file: `/procedure/data/local_data/ARIVALE_SNAPSHOTS/proteomics_metadata.tsv`
*   Feedback file indicating the issue: `/home/ubuntu/biomapper/roadmap/_active_prompts/feedback/2025-05-30-185108-feedback-mapping-executor-perf-test.md`

## 4. Deliverables

1.  **Analysis of Configuration Errors:**
    *   Identify the specific Arivale-related `MappingResource` entries in `populate_metamapper_db.py` that have incorrect `config_template` JSON.
    *   Determine the root cause of the JSON parsing errors (e.g., syntax issues, incorrect quoting, unexpected characters).

2.  **Corrected `populate_metamapper_db.py`:**
    *   Modify `/home/ubuntu/biomapper/scripts/populate_metamapper_db.py` to ensure the `config_template` for all Arivale clients is valid JSON and correctly represents the client's expected configuration parameters (e.g., `file_path`, `key_column`, `value_column`, `delimiter`).
    *   Ensure the `file_path` in the configurations correctly points to `/procedure/data/local_data/ARIVALE_SNAPSHOTS/proteomics_metadata.tsv`.

3.  **Verification Script/Steps:**
    *   Provide a small Python script or a series of steps (e.g., using `sqlite3` CLI and Python snippets) to:
        *   Delete and re-populate `metamapper.db` using the corrected `populate_metamapper_db.py`.
        *   Instantiate the relevant Arivale clients (e.g., `ArivaleMetadataLookupClient`) using the configurations retrieved from the updated `metamapper.db`.
        *   Confirm that the clients initialize without JSON parsing errors.
        *   (Optional but recommended) Perform a simple mapping operation (e.g., map a few known UniProt IDs to Arivale IDs and vice-versa) to ensure the clients are functional with the corrected configurations.

4.  **Markdown Feedback File (Critical):**
    *   Create a Markdown feedback file named `YYYY-MM-DD-HHMMSS-feedback-fix-arivale-client-config.md` (using the UTC timestamp of task completion) in the directory `/home/ubuntu/biomapper/roadmap/_active_prompts/feedback/`.
    *   This file must summarize:
        *   The specific Arivale client configurations that were problematic.
        *   The nature of the JSON errors found.
        *   The changes made to `populate_metamapper_db.py` to correct these errors.
        *   Confirmation that the corrected configurations allow clients to initialize without errors.
        *   Results of any functional tests performed with the clients.
        *   Any other observations or recommendations.

## 5. Constraints and Considerations

*   Changes should be confined to the `config_template` strings within `populate_metamapper_db.py` for Arivale clients.
*   Ensure that the corrections are compatible with the existing logic in `ArivaleMetadataLookupClient` and any related reverse lookup clients.
*   The fix should ensure that these clients can correctly load and use the Arivale proteomics metadata file.

## 6. Verification

*   The modified `populate_metamapper_db.py` script runs successfully.
*   After re-populating `metamapper.db`, Arivale clients can be instantiated with their configurations without JSON errors.
*   Arivale clients can successfully perform basic lookup operations using the corrected configurations.
*   The Markdown feedback file is created in the specified location and provides a comprehensive summary.

Good luck!
