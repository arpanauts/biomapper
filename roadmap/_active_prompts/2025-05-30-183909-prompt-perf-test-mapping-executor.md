# Prompt for Performance Testing of MappingExecutor

**ID:** 2025-05-30-183909-prompt-perf-test-mapping-executor
**Source Prompt Reference:** `/home/ubuntu/biomapper/roadmap/_status_updates/_suggested_next_prompt.md` (Task initiated by Cascade AI based on user request Step Id: 1)
**Project:** Biomapper
**Generated by:** Cascade AI (Project Manager)
**Date:** 2025-05-30

## 1. Task Definition

Design and execute comprehensive performance tests for the `MappingExecutor` component of the Biomapper project. The primary goals are:
1.  To validate that the recently implemented client caching mechanism (MEMORY[7f07a007-bf51-4676-87c5-aacfa4fabccb]) provides sustained performance benefits when using larger, production-representative datasets.
2.  To identify any new or more subtle performance bottlenecks that may emerge under increased load.
3.  To measure mapping success rates alongside performance metrics.

## 2. Context

The `MappingExecutor` (`/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`) is a critical component for orchestrating mapping operations. A recent optimization involved adding a client instance cache (`_client_cache`) which dramatically improved performance for smaller test cases. This task is to ensure these improvements hold for realistic workloads.

Key project configurations are managed via `biomapper.config.settings` (see `/home/ubuntu/biomapper/biomapper/config.py`, MEMORY[7741c86c-2484-4059-b152-ebb2d67851c7]). The system uses `metamapper.db` for configuration and `mapping_cache.db` for caching results.

## 3. Input Materials

*   **Core Code:**
    *   `MappingExecutor`: `/home/ubuntu/biomapper/biomapper/core/mapping_executor.py`
*   **Configuration:**
    *   Project settings: Accessible via `from biomapper.config import settings`
    *   `metamapper.db`: Path available from `settings.metamapper_db_url`
    *   `mapping_cache.db`: Path available from `settings.cache_db_url`
*   **Production-Representative Datasets:**
    *   UKBB Protein Metadata: `/home/ubuntu/biomapper/data/UKBB_Protein_Meta_full.tsv` (MEMORY[87598b65-0bf2-40c3-be97-ad15baf90c5f]) - Contains UniProt IDs.
    *   Arivale Proteomics Metadata: `/procedure/data/local_data/ARIVALE_SNAPSHOTS/proteomics_metadata.tsv` (MEMORY[c136a4fa-18ad-40d7-aec1-869992d25ca2], MEMORY[c3f81352-4385-4f0e-b00f-c46577cbec43]) - Contains Arivale protein IDs and UniProt IDs.
    *   (Optional, if relevant paths exist) Arivale Metabolomics Metadata: `/procedure/data/local_data/ARIVALE_SNAPSHOTS/metabolomics_metadata.tsv` (MEMORY[f900e650-72b2-4f1d-9c52-2354373019c6])
*   **Existing Scripts (for reference/adaptation):**
    *   `map_ukbb_to_arivale.py`: `/home/ubuntu/biomapper/scripts/map_ukbb_to_arivale.py`
    *   Consider adapting the structure of tests from `tests/core/test_mapping_executor.py` for larger scale testing.

## 4. Deliverables

1.  **Performance Test Script:**
    *   Create a new Python script, e.g., `/home/ubuntu/biomapper/scripts/stress_test_mapping_executor.py`.
    *   This script should:
        *   Utilize `biomapper.config.settings` for database paths and other configurations.
        *   Load input identifiers from the specified large datasets (e.g., UKBB UniProt ACs).
        *   Execute `MappingExecutor.execute_mapping()` for one or more significant mapping paths (e.g., UKBB UniProt AC to Arivale Protein ID).
        *   Implement robust measurement of:
            *   Total execution time.
            *   Memory usage during the test (e.g., using `memory-profiler` or `psutil`, if feasible and not overly complex).
            *   Number of input IDs processed.
            *   Number of successful mappings and overall success rate.
        *   Allow for configurable input sizes (e.g., test with 1,000, 10,000, 100,000, and the full set of available input IDs from the chosen dataset).
        *   Include clear logging of test progress, parameters, and results.
        *   Handle potential errors gracefully and report them.

2.  **Results Summary File:**
    *   Generate a structured results file (e.g., JSON or Markdown) in `/home/ubuntu/biomapper/data/testing_results/mapping_executor_perf_test_results_YYYYMMDD_HHMMSS.[json|md]`.
    *   This file should detail:
        *   Test run timestamp.
        *   Specific mapping path(s) tested.
        *   For each input size tested:
            *   Input dataset and number of IDs.
            *   Execution time.
            *   Peak memory usage (if measured).
            *   Number of successful mappings.
            *   Mapping success rate (%).
        *   Any errors, warnings, or unexpected behavior encountered.
        *   A qualitative assessment of performance and any observed bottlenecks (e.g., "Performance scales linearly up to 100k inputs, then slows," or "Memory usage becomes a concern above 50k inputs").

3.  **Markdown Feedback File (Critical):**
    *   Create a Markdown feedback file named `YYYY-MM-DD-HHMMSS-feedback-mapping-executor-perf-test.md` (using the UTC timestamp of task completion) in the directory `/home/ubuntu/biomapper/roadmap/_active_prompts/feedback/`.
    *   This file must summarize:
        *   A brief overview of the tests designed and executed.
        *   Key performance metrics and mapping success rates observed across different data scales.
        *   Confirmation of sustained performance or identification of any new bottlenecks.
        *   Any challenges encountered during test development or execution.
        *   Specific recommendations for further investigation or optimization if new bottlenecks are found, or if performance degrades unexpectedly at scale.
        *   A statement on whether the client caching appears sufficient for large datasets.

## 5. Constraints and Considerations

*   Ensure the test script is runnable from the project root (`/home/ubuntu/biomapper/`).
*   The script should be well-documented with comments.
*   Prioritize testing mapping paths that are crucial for the UKBB-Arivale MVP.
*   If direct memory profiling is too complex to implement reliably, focus on execution time and success rates, but note any obvious memory issues if they arise (e.g., crashes, extreme slowdowns).
*   The primary goal is to understand how `MappingExecutor` behaves under load with realistic data, not necessarily to achieve exhaustive profiling of every sub-component in this single task.

## 6. Verification

*   The test script runs without errors for various configured input sizes.
*   The results summary file is generated correctly and contains all required information.
*   The Markdown feedback file is created in the specified location and provides a comprehensive summary.

Good luck!
